<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Instinct Index | 11 Dimensions Behavioral Diagnostic</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600;800&display=swap');
        :root {
            --brand-cyan: #00f0ff;
            --brand-teal: #2dd4bf;
            --deep-slate: #0f172a;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: radial-gradient(circle at 50% -20%, #1e293b 0%, #0f172a 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .serif { font-family: 'Libre Baskerville', serif; }
        .glass-card {
            background: rgba(30,41,59,0.75);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(12px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
        }
        .title-ai { color: #fff; }
        .title-instinct { color: var(--brand-cyan); }
        .title-index { color: var(--brand-teal); }
        
        .tm-mark { 
            font-size: 0.5em; 
            vertical-align: super; 
            margin-left: -2px; 
            margin-right: 2px;
            color: var(--brand-teal); 
            font-weight: 700;
            position: relative;
            top: -0.2em;
        }

        .likert-btn {
            background: rgba(15,23,42,0.6);
            border: 2px solid rgba(255,255,255,0.04);
            transition: transform .1s ease, background .1s, box-shadow .1s;
            min-height: 60px; /* Smaller default for mobile stack */
            display:flex;
            align-items:center;
            justify-content:center;
            cursor: pointer;
        }
        @media (min-width: 640px) {
            .likert-btn { min-height: 100px; } /* Larger on desktop */
        }
        .likert-btn:active { transform: scale(0.96); }
        .likert-btn.selected {
            background: var(--brand-cyan);
            border-color: var(--brand-cyan);
            color: #000;
            transform: scale(1.02);
            box-shadow: 0 14px 30px rgba(0,240,255,0.18);
        }
        
        /* Smooth Fade Animation Styles - No Shaking */
        #survey-content { 
            overflow: hidden; 
            position: relative;
            /* Height handled by min-height in container for responsiveness */
            display: flex;
            flex-direction: column;
        }
        #survey-inner { 
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            padding-top: 1rem;
            opacity: 1;
            transition: opacity 0.25s ease-in-out;
        }
        
        #survey-inner.fade-out {
            opacity: 0;
        }

        .not-sure-btn {
            margin-top: 1rem; display:inline-block; padding: 0.6rem 1.2rem; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03);
            color: #e6f7f6; font-weight: 700; letter-spacing: 0.06em; font-size: 0.75rem;
            transition: background .22s ease, transform .16s ease, box-shadow .18s; cursor: pointer;
        }
        .not-sure-btn.flash {
            background: var(--brand-teal); color: #042018; transform: scale(1.03); box-shadow: 0 12px 28px rgba(45,212,191,0.18);
        }
        .pips-container { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-bottom:1.5rem; }
        .pip { width:6px; height:6px; border-radius:999px; background:#334155; transition:all .18s; cursor: pointer; position: relative; }
        .pip:hover { background: #94a3b8; transform:scale(1.2); }
        .pip:hover::after { content: attr(data-question); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,240,255,0.95); color: #000; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; white-space: nowrap; margin-bottom: 6px; box-shadow: 0 4px 12px rgba(0,240,255,0.4); z-index: 100; pointer-events: none; }
        .pip:hover::before { content: ''; position: absolute; bottom: calc(100% - 4px); left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: rgba(0,240,255,0.95); z-index: 100; pointer-events: none; }
        .pip.active { background:var(--brand-cyan); transform:scale(1.5); box-shadow:0 0 8px var(--brand-cyan); }
        .pip.completed { background:var(--brand-teal); opacity:0.8; }
        .pip.notsure { background: #ef4444; opacity: 0.95; }
        .modal-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.9); backdrop-filter:blur(6px); display:flex; align-items:center; justify-content:center; z-index:1000; }
        
        #chart-buffer { position:absolute; left:-9999px; visibility:hidden; width: 800px; height: 800px; }
        #trend-buffer { position:absolute; left:-9999px; visibility:hidden; width: 800px; height: 400px; }

        /* Enhanced Navigation Buttons */
        .nav-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--brand-cyan);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .nav-icon-btn:hover {
            background: rgba(0,240,255,0.15);
            border-color: var(--brand-cyan);
            transform: scale(1.1);
        }
        .nav-icon-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <nav class="border-b border-white/5 bg-slate-900/80 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="app.navigate('hero')">
                <span class="font-black text-lg tracking-widest uppercase">
                    <span class="title-ai">AI</span> <span class="title-instinct italic serif">Instinct</span> <span class="title-index">Index</span><sup class="tm-mark">®</sup>
                </span>
            </div>
            <div id="nav-actions" class="flex items-center space-x-6"></div>
        </div>
    </nav>

    <main id="view-port" class="max-w-6xl mx-auto px-4 py-8 md:py-12"></main>

    <div id="chart-buffer"><canvas id="radar-canvas" width="800" height="800"></canvas></div>
    <div id="trend-buffer"><canvas id="trend-canvas-pdf" width="800" height="400"></canvas></div>

    <script>
    const CONFIG = { 
        ADMIN_PASS: "admin1510",
        // Using provided web app URL
        GOOGLE_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxd7KyNIi-MJomaPhQU6u2RK9kW6pDEyXcbnxmWTZwzNzcfWhPgaPKQapJGkX8yHUHN/exec"
    };

    // Glossary Content
    const GLOSSARY_CONTENT = [
        {
            title: "Dimension 1 — Exploration (Try)",
            desc: "What this measures: Willingness to experiment: curiosity for new tools, propensity to pilot emerging AI features, and the readiness to try before perfecting. This dimension captures whether people seek out possibilities or wait for explicit mandates."
        },
        {
            title: "Dimension 2 — Persistence (Sustain)",
            desc: "What this measures: The degree to which people continue using AI beyond initial trials — their willingness to troubleshoot, develop habits, and embed tools into everyday workflows."
        },
        {
            title: "Dimension 3 — Integration (Normalize)",
            desc: "What this measures: How effectively AI becomes part of regular practice: alignment with governance, ethical norms, and operational processes that make AI a predictable, normal way of working."
        },
        {
            title: "Dimension 4 — Influence (Scale)",
            desc: "What this measures: Capacity of early adopters and peers to influence others — presence of internal champions, communities of practice, and social mechanisms that spread successful use."
        },
        {
            title: "Dimension 5 — Psychological Barriers",
            desc: "What this measures: Emotional and identity-related resistance: fear of replacement, anxiety about mistakes, and the stigma or identity threat tied to using AI."
        },
        {
            title: "Dimension 6 — Digital Temperament",
            desc: "What this measures: Comfort with uncertainty, probabilistic outputs, and evolving systems — the psychological style that determines how people tolerate ambiguity in digital tools."
        },
        {
            title: "Dimension 7 — Trust & Explainability",
            desc: "What this measures: Confidence in AI outputs and the organization’s ability to explain how tools arrive at recommendations. This includes access to performance metrics and transparent communication about limitations."
        },
        {
            title: "Dimension 8 — Leadership & Change Management",
            desc: "What this measures: Visibility and credibility of leaders in the AI journey: whether leaders model usage, align messages with actions, and sponsor change in practical ways."
        },
        {
            title: "Dimension 9 — Policy & Communication",
            desc: "What this measures: Clarity and consistency of policies, the existence of an accessible “AI charter,” and how messages flow across the organization."
        },
        {
            title: "Dimension 10 — Benefit Realization",
            desc: "What this measures: Perception and measurement of tangible benefits (time saved, error reduction, quality improvement) — whether people can connect AI adoption to real outcomes."
        },
        {
            title: "Dimension 11 — Adoption Stage & Barriers",
            desc: "What this measures: How far adoption has progressed (from awareness to pilots to scale) and the practical barriers that prevent pilots from scaling (bureaucracy, tooling mismatch, governance friction)."
        }
    ];

    const SUGGESTIONS_POOL = {
        STRONG: [
            "Consolidate and maintain gains: schedule periodic reflection (monthly) to document examples where you used [DIMENSION] in real work situations.",
            "Stretch into leadership by mentoring one peer on [DIMENSION] — teaching consolidates expertise and exposes edge cases.",
            "Design a ‘challenge project’ (4–8 weeks) that leverages [DIMENSION] in a novel domain — this tests breadth and transferability.",
            "Measure stability: collect brief behavioral evidence (2–3 examples) regarding [DIMENSION] and solicit 360° feedback to confirm external validity.",
            "Guard against complacency: create one specific learning objective each quarter to broaden [DIMENSION] application (e.g., explore adjacent skills)."
        ],
        MODERATE: [
            "Targeted deliberate practice: identify 1–2 subskills within [DIMENSION] and practice them with short, focused exercises (15–30 mins, 3×/week).",
            "Use feedback loops: ask for immediate, behavior-specific feedback after tasks involving [DIMENSION] and incorporate it immediately.",
            "Behavioral experiments: set up small, measurable experiments (A/B style) to try alternative approaches to [DIMENSION] and track outcomes.",
            "Build scaffolding: pair up with a peer who models strong [DIMENSION] behaviors and ask for guided practice or observation.",
            "Monitor progress quantitatively: track a simple metric (frequency or success rate) related to [DIMENSION] and review weekly."
        ],
        EMERGING: [
            "Start with micro-goals: break [DIMENSION] into the smallest observable behaviors (one concrete action) and practise it daily for 2 weeks.",
            "Use implementation intentions (If-Then plans) to increase follow-through (e.g., “If I start a task, I will apply one [DIMENSION] principle”).",
            "Seek low-stakes practice opportunities for [DIMENSION] (simulations, role-play) to build competence without high fear of failure.",
            "Leverage accountability: schedule brief weekly check-ins with a mentor to review [DIMENSION] progress and obstacles.",
            "Gather simple evidence of change: document short before/after examples of [DIMENSION]; ask a colleague for one concrete observation after 4 weeks."
        ]
    };

    const dimensionsData = [
        { name: "Exploration", desc: "The cognitive drive to proactively investigate, experiment, and pilot emergent AI capabilities beyond mandated workflows.", scientific: "Empirical data suggests that high Exploration scores correlate with reduced time-to-value in software deployments. It represents the 'Curiosity Quotient' applied to digital tools.", dev: "Institutionalize 'Innovation Sprints' where experimentation is decoupled from immediate KPIs. Establish safe-to-fail sandboxes to lower the psychological barrier to entry." },
        { name: "Persistence", desc: "The behavioral resilience required to troubleshoot hallucinations, non-deterministic outputs, and initial tool friction.", scientific: "Iterative persistence is the primary differentiator between casual users and 'power users.' This dimension measures the tolerance for computational ambiguity.", dev: "Reward the documentation of failure as much as success. Create a 'Prompt Library' where shared troubleshooting becomes organizational knowledge." },
        { name: "Integration", desc: "The degree of alignment between AI use and established ethical, legal, and operational governance structures.", scientific: "Unchecked integration poses systemic risk. High scores reflect an internalisation of governance as a facilitator rather than a constraint.", dev: "Embed ethics checkpoints directly into tool interfaces. Conduct regular workshops on algorithmic bias and data privacy to maintain high awareness levels." },
        { name: "Influence", desc: "Social contagion and peer-to-peer advocacy for AI adoption within internal professional networks.", scientific: "Diffusion of Innovation theory posits that 'Influence' is the engine of the majority's adoption. This measures the peer-led network effect.", dev: "Formalize internal 'Champion' roles. Implement peer-mentoring programs where high-influence individuals guide more hesitant colleagues." },
        { name: "Psychological Barriers", desc: "Socio-psychological security regarding professional identity and perceived replacement threats.", scientific: "Identity threat is the leading cause of covert resistance. This dimension tracks the shift from 'replacement anxiety' to 'augmentation confidence'.", dev: "Explicitly communicate AI as a 'Human-in-the-loop' augmentation tool. Highlight the displacement of mundane tasks to favor high-value creative work." },
        { name: "Digital Temperament", desc: "Comfort with probabilistic logic and non-deterministic technological environments.", scientific: "Classic computing is binary; AI is probabilistic. This dimension measures the cognitive flexibility required for non-linear digital interactions.", dev: "Educate staff on 'Confidence Intervals' in AI output. Shift performance metrics from 'Binary Correctness' to 'Weighted Accuracy' in experimental phases." },
        { name: "Trust & Explainability", desc: "Confidence in institutional AI logic, transparency of systems, and the reliability of organizational outputs.", scientific: "Trust is a multifaceted construct involving system reliability and human transparency. It is the foundation of long-term sustainable adoption.", dev: "Promote Explainable AI (XAI) tools. Ensure leadership transparency regarding which AI systems are used and for what specific purposes." },
        { name: "Leadership & Change", desc: "Executive commitment, resource allocation, and active behavioral role-modeling of AI proficiency.", scientific: "Organizational culture is a shadow of leadership. This measures the executive 'buy-in' through visible action and funding allocation.", dev: "Encourage leaders to share their personal AI use-cases. Implement reverse-mentoring where junior AI experts advise senior leadership teams." },
        { name: "Policy & Communication", desc: "Clarity of institutional guardrails, incentivization structures, and evolving governance rules.", scientific: "Policy lag often hampers innovation. This dimension measures the effectiveness and accessibility of the regulatory framework.", dev: "Transition from static policy documents to dynamic 'Living Guidelines'. Simplify approved tool lists with clear, tiered access levels based on risk." },
        { name: "Benefit Realization", desc: "Tangible perception of quality, speed, or creative gains facilitated by AI tool usage.", scientific: "The 'Value-Capture' perception determines sustained usage. Without visible benefit, adoption eventually regresses to the mean.", dev: "Track and publish time-saved metrics across different departments. Highlight qualitative wins where AI enabled previously impossible creative feats." },
        { name: "Adoption & Barriers", desc: "Structural embedding of AI into core daily operations and longitudinal workflow consistency.", scientific: "Adoption is the final stage of maturity, moving from pilot phases to 'business-as-usual' infrastructure. It reflects the normalization of AI.", dev: "Monitor the 'Pilot-to-Scale' ratio. Ensure that successful AI experiments are systematically converted into standard operating procedures (SOPs)." },
        { name: "Attention Check", desc: "Quality control items to detect inattentive or careless responding.", scientific: "Reverse-coded attention checks help identify response patterns that may indicate lack of engagement or understanding.", dev: "Flag responses where attention check items are answered inconsistently with their reverse-coded nature." }
    ];

    const allQuestions = [
        { dIdx:0, text:"I make time to try new AI features even before they're required at work.", reverse:false },
        { dIdx:0, text:"Experimenting with AI energizes me professionally.", reverse:false },
        { dIdx:0, text:"I try to get early/beta access to new AI tools so I can learn them first.", reverse:false },
        { dIdx:0, text:"I often think about how AI could solve the problems I face at work.", reverse:false },
        { dIdx:1, text:"If an AI output is wrong, I try a different prompt or approach right away.", reverse:false },
        { dIdx:1, text:"I'm willing to spend time tweaking an AI response until it's right.", reverse:false },
        { dIdx:1, text:"I treat AI mistakes as puzzles to fix, not reasons to stop using the tool.", reverse:false },
        { dIdx:1, text:"I keep working with an AI-based process even when setup is confusing.", reverse:false },
        { dIdx:2, text:"I always check that my AI use follows our company's data privacy rules.", reverse:false },
        { dIdx:2, text:"I feel responsible for checking AI outputs for bias or ethical problems.", reverse:false },
        { dIdx:2, text:"I document how I use AI so others can review or audit the process.", reverse:false },
        { dIdx:2, text:"For important tasks, I choose ethical safety over speed when using AI.", reverse:false },
        { dIdx:3, text:"I often explain the benefits of AI to colleagues who are unsure.", reverse:false },
        { dIdx:3, text:"Team members come to me for advice about using AI effectively.", reverse:false },
        { dIdx:3, text:"I actively encourage my department to adopt more advanced AI workflows.", reverse:false },
        { dIdx:3, text:"I would be comfortable leading an AI-related project if asked.", reverse:false },
        { dIdx:4, text:"I see AI as a partner that increases my human strengths, not as a rival.", reverse:false },
        { dIdx:4, text:"I feel secure about my job prospects despite rapid AI growth.", reverse:false },
        { dIdx:4, text:"I'm more excited than worried about how my role may evolve with AI.", reverse:false },
        { dIdx:4, text:"Using AI makes me feel more creative and capable in my work.", reverse:false },
        { dIdx:5, text:"I'm okay with AI sometimes giving different answers to the same question.", reverse:false },
        { dIdx:5, text:"I enjoy working in tech environments that change frequently.", reverse:false },
        { dIdx:5, text:"Uncertain software performance does not reduce my productivity.", reverse:false },
        { dIdx:5, text:"I'm comfortable adapting to new software interfaces and features.", reverse:false },
        { dIdx:6, text:"I trust that our organization chooses AI tools that are safe and reliable.", reverse:false },
        { dIdx:6, text:"I believe the AI outputs I get are generally accurate and sensible.", reverse:false },
        { dIdx:6, text:"My organization is clear about how it uses AI internally.", reverse:false },
        { dIdx:6, text:"I have confidence in the algorithms behind our main business tools.", reverse:false },
        { dIdx:7, text:"My direct manager uses AI visibly to improve their work.", reverse:false },
        { dIdx:7, text:"Senior leadership has a clear plan for how AI will change the business.", reverse:false },
        { dIdx:7, text:"Executives regularly update staff about AI strategy and progress.", reverse:false },
        { dIdx:7, text:"I feel supported by management when I try new AI tools.", reverse:false },
        { dIdx:8, text:"The rules for using AI in my work are clear and easy to find.", reverse:false },
        { dIdx:8, text:"I know which AI tools are approved and which are restricted at work.", reverse:false },
        { dIdx:8, text:"Our policies make me feel safe to use AI within set boundaries.", reverse:false },
        { dIdx:8, text:"I find our AI governance helpful, not just restrictive.", reverse:false },
        { dIdx:9, text:"AI has improved the quality of my work output.", reverse:false },
        { dIdx:9, text:"I save a noticeable amount of time each week using AI for routine tasks.", reverse:false },
        { dIdx:9, text:"AI lets me focus more on strategy and less on repetitive work.", reverse:false },
        { dIdx:9, text:"I can handle more work without more stress because of AI.", reverse:false },
        { dIdx:10, text:"AI tools are now an essential part of my daily work.", reverse:false },
        { dIdx:10, text:"It would be hard for me to do my job well without AI today.", reverse:false },
        { dIdx:10, text:"Most of my main workflows include an AI component.", reverse:false },
        { dIdx:10, text:"Using AI in my role feels like the new normal, not a passing trend.", reverse:false },
        { dIdx:11, text:"I avoid using AI tools because they threaten my job security. [coded]", reverse:true },
        { dIdx:11, text:"I stop trying when an AI tool gives an incorrect answer. [coded]", reverse:true }
    ];

    let radarChart = null;
    let pdfRadarChart = null;
    let trendChart = null;
    let pdfTrendChart = null;
    let historyTrendChart = null;

    const app = {
        state: {
            view: 'hero',
            user: null,
            answers: new Array(allQuestions.length).fill(null),
            currentIdx: 0,
            isAdmin: false,
            responses: JSON.parse(localStorage.getItem('ai_instinct_v8') || '[]'),
            surveyId: 'RES-' + Math.random().toString(36).substr(2,8).toUpperCase(),
            historyLookupResults: [],
            viewingHistory: false,
            isTransitioning: false
        },

        init() {
            this.updateNav();
            this.render();
            window.aiInstinctApp = this;
        },

        updateNav() {
            const nav = document.getElementById('nav-actions');
            if (this.state.isAdmin) {
                nav.innerHTML = `<button onclick="app.logout()" class="text-rose-400 hover:text-rose-300 transition text-[10px] font-bold uppercase tracking-widest"><i class="fa-solid fa-power-off mr-2"></i>Logout</button>`;
            } else {
                nav.innerHTML = `<button onclick="app.navigate('admin')" class="text-slate-400 hover:text-cyan-400 transition text-[10px] font-bold uppercase tracking-widest"><i class="fa-solid fa-shield-halved mr-1"></i>Admin</button>`;
            }
        },

        render() {
            const port = document.getElementById('view-port');
            port.innerHTML = '';
            if (this.state.view === 'hero') this.renderHero(port);
            else if (this.state.view === 'welcome') this.renderWelcome(port);
            else if (this.state.view === 'reg') this.renderReg(port);
            else if (this.state.view === 'survey') this.renderSurvey(port);
            else if (this.state.view === 'results') this.renderResults(port);
            else if (this.state.view === 'admin') this.renderAdmin(port);
            else if (this.state.view === 'history') this.renderHistoryLookup(port);
            else if (this.state.view === 'userHistory') this.renderUserHistory(port);
        },

        renderHero(p) {
            p.innerHTML = `
                <div class="text-center py-20">
                    <div class="inline-block px-4 py-1 rounded-full border border-cyan-500/30 bg-cyan-500/5 text-cyan-400 text-[10px] font-bold tracking-[0.3em] mb-8 uppercase">Scholarly Behavioral Diagnostic</div>
                    <h1 class="text-6xl font-extrabold mb-6 tracking-tight">
                        <span class="title-ai">AI</span> <span class="title-instinct italic serif">Instinct</span> <span class="title-index">Index</span><sup class="tm-mark">®</sup>
                    </h1>
                    <p class="text-xl text-slate-400 mb-12 max-w-2xl mx-auto serif italic leading-relaxed">
                        A rigorous, scholarly psychometric instrument grounded in behavioral science and organizational research, assessing institutional and individual readiness for AI integration across 11 dimensions and 46 behavioral metrics.
                    </p>
                    <div class="flex flex-col md:flex-row gap-4 justify-center">
                        <button onclick="app.navigate('welcome')" class="bg-white text-slate-950 font-black px-12 py-5 rounded-full hover:bg-cyan-400 transition-all shadow-xl uppercase tracking-widest text-xs">Initialize Diagnostic</button>
                        <button onclick="app.navigate('history')" class="bg-transparent border border-white/20 text-slate-300 font-bold px-12 py-5 rounded-full hover:bg-white/5 transition-all uppercase tracking-widest text-xs">My History</button>
                    </div>
                </div>
            `;
        },

        renderWelcome(p) {
            p.innerHTML = `
                <div class="text-center py-6 md:py-10 max-w-4xl mx-auto">
                    <!-- Processor Icon -->
                    <div class="flex justify-center mb-6">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-teal-400/20 to-cyan-500/20 border border-teal-500/30 flex items-center justify-center">
                            <svg class="w-10 h-10 text-teal-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M5 5h4V3H5v2zm0 6h4V9H5v2zm0 6h4v-2H5v2zm10-8h4V7h-4v2zm0 6h4v-2h-4v2zm0 6h4v-2h-4v2zM3 21h2V3H3v18zm16 0h2V3h-2v18zM11 3H9v2h2V3zm0 4H9v2h2V7zm0 4H9v2h2v-2zm0 4H9v2h2v-2zm0 4H9v2h2v-2z"/>
                            </svg>
                        </div>
                    </div>

                    <h1 class="text-4xl md:text-5xl font-bold mb-4 text-slate-100">Welcome to the Diagnostic</h1>
                    
                    <p class="text-lg md:text-xl text-slate-400 mb-8 max-w-3xl mx-auto leading-relaxed">
                        The <span class="font-bold text-white">AI Instinct Index<sup class="tm-mark">®</sup></span> evaluates your innate approach to human-machine collaboration across 11 critical dimensions. There are no right or wrong answers—only patterns of behavior.
                    </p>

                    <!-- Information Grid -->
                    <div class="max-w-3xl mx-auto mb-10">
                        <div class="glass-card rounded-3xl p-8 md:p-10">
                            <div class="grid md:grid-cols-2 gap-6 text-left">
                                <!-- Time Estimate -->
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-teal-500/10 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-clock text-teal-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-slate-300 text-sm md:text-base">
                                            Approx. <span class="font-bold text-white">4-6 minutes</span> to complete.
                                        </p>
                                    </div>
                                </div>

                                <!-- Instinctive Answers -->
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-bolt text-cyan-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-slate-300 text-sm md:text-base">
                                            Please answer <span class="font-bold text-white">instinctively</span> for best results.
                                        </p>
                                    </div>
                                </div>

                                <!-- PDF Report -->
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-teal-500/10 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-file-pdf text-teal-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-slate-300 text-sm md:text-base">
                                            Download a comprehensive <span class="font-bold text-white">PDF report</span> at the end.
                                        </p>
                                    </div>
                                </div>

                                <!-- Local Processing -->
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-lock text-cyan-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-slate-300 text-sm md:text-base">
                                            All data is processed <span class="font-bold text-white">locally</span> in your browser.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                        <button onclick="app.navigate('reg')" class="bg-gradient-to-r from-teal-600 to-teal-500 text-white font-black px-12 py-5 rounded-full hover:from-teal-500 hover:to-teal-400 transition-all shadow-xl uppercase tracking-widest text-xs flex items-center gap-3">
                            Start Assessment
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
        },

        renderHistoryLookup(p) {
            p.innerHTML = `
                <div class="py-6 md:py-10">
                    <div class="max-w-xl mx-auto glass-card p-12 rounded-[2rem] text-center">
                        <h2 class="text-2xl font-bold mb-4 uppercase tracking-tight">Access Previous Reports</h2>
                        <p class="text-slate-400 mb-8 text-sm">Enter the corporate email address used for previous assessments to retrieve your history.</p>
                        <form id="history-form" class="space-y-6">
                            <input required type="email" name="email" class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-4 focus:border-cyan-500 outline-none text-white text-center" placeholder="name@company.com">
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-5 rounded-xl hover:bg-cyan-500 transition-all uppercase tracking-widest text-xs">Search Records</button>
                        </form>
                        <button onclick="app.navigate('hero')" class="mt-6 text-[10px] font-bold text-slate-500 uppercase tracking-widest hover:text-white transition">Cancel</button>
                    </div>
                </div>
            `;
            const form = document.getElementById('history-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                const email = fd.get('email').toString().trim().toLowerCase();
                this.lookupHistory(email);
            });
        },

        lookupHistory(email) {
            const results = this.state.responses.filter(r => r.user.email.toLowerCase().trim() === email)
                .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (results.length === 0) {
                alert('No records found for this email address.');
                return;
            }
            this.state.historyLookupResults = results;
            this.navigate('userHistory');
        },

        renderUserHistory(p) {
            p.innerHTML = `
                <div class="py-6 md:py-10">
                    <div class="max-w-3xl mx-auto space-y-8">
                        <div class="flex justify-between items-end border-b border-white/5 pb-4">
                            <h2 class="text-2xl font-bold uppercase tracking-tight">Assessment History</h2>
                            <button onclick="app.navigate('hero')" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest hover:text-white">Close</button>
                        </div>

                        <div class="glass-card p-6 rounded-[2rem] mb-6 border border-white/5">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Readiness Progression</div>
                            <div class="h-[250px]"><canvas id="history-trend-canvas"></canvas></div>
                        </div>

                        <div class="glass-card rounded-[2rem] overflow-hidden">
                             <table class="w-full text-left text-sm">
                                <thead class="bg-white/5 text-[10px] uppercase font-bold text-slate-500 tracking-widest">
                                    <tr><th class="px-6 py-4">Date</th><th class="px-6 py-4 text-center">Overall Score</th><th class="px-6 py-4 text-right">Actions</th></tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${this.state.historyLookupResults.map((r, i) => `
                                        <tr class="hover:bg-white/5 transition">
                                            <td class="px-6 py-6"><div class="font-bold text-slate-200">${r.timestamp.split(',')[0]}</div><div class="text-[9px] font-mono text-slate-600">${r.id}</div></td>
                                            <td class="px-6 py-6 text-center"><span class="font-black ${r.overall >= 75 ? 'text-teal-400' : (r.overall >= 50 ? 'text-cyan-400' : 'text-rose-400')}">${r.overall}%</span></td>
                                            <td class="px-6 py-6 text-right space-x-4">
                                                <button onclick="app.viewHistoricalReport(${i})" class="text-[9px] font-bold text-cyan-400 uppercase hover:text-white">View</button>
                                                <button onclick="app.downloadHistoricalPDF(${i})" class="text-slate-500 hover:text-cyan-400"><i class="fa-solid fa-file-pdf"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                if(this.state.historyLookupResults.length > 0) {
                    const email = this.state.historyLookupResults[0].user.email;
                    const hData = this.getTrendData(email);
                    this.drawTrend('history-trend-canvas', hData, false, true);
                }
            }, 60);
        },

        viewHistoricalReport(idx) {
            const record = this.state.historyLookupResults[idx];
            this.state.user = record.user;
            this.state.surveyId = record.id;
            this.state.viewingHistory = true;
            this.navigate('results');
        },

        downloadHistoricalPDF(idx) {
            this.generatePDF(this.state.historyLookupResults[idx]);
        },

        renderReg(p) {
            p.innerHTML = `
                <div class="py-6 md:py-10">
                    <div class="max-w-xl mx-auto glass-card p-12 rounded-[2rem]">
                        <h2 class="text-2xl font-bold mb-8 uppercase tracking-tight text-center">Enrollment</h2>
                        <form id="reg-form" class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Participant Name</label>
                                <input required name="name" class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-4 focus:border-cyan-500 outline-none text-white" value="${this.state.user ? this.state.user.name : ''}">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Corporate Email</label>
                                <input required type="email" name="email" class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-4 focus:border-cyan-500 outline-none text-white" value="${this.state.user ? this.state.user.email : ''}">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Country</label>
                                <input required name="country" class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-4 focus:border-cyan-500 outline-none text-white" value="${this.state.user ? this.state.user.country : ''}" placeholder="e.g., India">
                            </div>
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-5 rounded-xl hover:bg-cyan-500 transition-all uppercase tracking-widest text-xs">Begin ${allQuestions.length}-Point Analysis</button>
                        </form>
                    </div>
                </div>
            `;

            const form = document.getElementById('reg-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(form);
                    const name = (fd.get('name') || '').toString().trim();
                    const email = (fd.get('email') || '').toString().trim();
                    const country = (fd.get('country') || '').toString().trim();
                    if (!name || !email || !country) { alert('Please enter name, email and country'); return; }
                    this.state.user = { name, email, country };
                    this.state.viewingHistory = false;
                    if(!this.state.answers.length) this.state.answers = new Array(allQuestions.length).fill(null);
                    this.navigate('survey');
                });
            }
        },

        renderSurvey(p) {
            const q = allQuestions[this.state.currentIdx];
            const selected = this.state.answers[this.state.currentIdx];
            const dimName = dimensionsData[q.dIdx].name;

            const pipsHtml = allQuestions.map((_, i) => {
                let classes = 'pip'; 
                // Only make clickable if answered or if all previous questions are answered
                let isClickable = false;
                if (this.state.answers[i] !== null) {
                    isClickable = true;
                } else {
                    // Check if all previous questions are answered
                    let allPreviousAnswered = true;
                    for (let j = 0; j < i; j++) {
                        if (this.state.answers[j] === null) {
                            allPreviousAnswered = false;
                            break;
                        }
                    }
                    isClickable = allPreviousAnswered;
                }
                
                if (!isClickable) classes += ' opacity-30';
                else classes += ' cursor-pointer';
                
                if (i === this.state.currentIdx) classes += ' active';
                else if (this.state.answers[i] !== null && this.state.answers[i] > 0) classes += ' completed';
                else if (this.state.answers[i] === -1) classes += ' notsure';
                
                const onclick = isClickable ? `onclick="app.jumpTo(${i})"` : '';
                return `<div ${onclick} title="Question ${i+1}" data-question="Q${i+1}" class="${classes}"></div>`;
            }).join('');

            // Check if back button should be enabled (any previous question answered)
            let hasPreviousAnswered = false;
            for (let i = this.state.currentIdx - 1; i >= 0; i--) {
                if (this.state.answers[i] !== null) {
                    hasPreviousAnswered = true;
                    break;
                }
            }

            // Check if next button should be enabled (current question answered)
            const isCurrentAnswered = this.state.answers[this.state.currentIdx] !== null;

            // Optimized Layout: Smaller max width, flexible height, better mobile handling
            p.innerHTML = `
                <div class="py-4 md:py-6">
                    <div class="max-w-3xl mx-auto">
                        <div class="pips-container">
                            ${pipsHtml}
                        </div>
                        
                        <div id="survey-content" class="glass-card p-6 md:p-10 rounded-[2rem] border-t-4 border-cyan-500/50 relative min-h-[500px]">
                            <div id="survey-inner">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="text-cyan-400 font-bold text-[10px] tracking-[0.4em] uppercase flex items-center">
                                        <span class="h-px w-8 bg-cyan-400 mr-4"></span> Dimension: ${dimName}
                                    </div>
                                    <span class="text-[9px] text-slate-500 font-mono uppercase tracking-widest">ID: ${this.state.surveyId} | ${this.state.currentIdx + 1}/${allQuestions.length}</span>
                                </div>
                                
                                <div class="min-h-[100px] flex flex-col justify-start mb-8">
                                    <h2 class="text-xl md:text-3xl font-bold leading-tight text-slate-100 serif italic">"${q.text}"</h2>
                                </div>

                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-3">
                                ${[1,2,3,4,5].map(v => `
                                    <button id="btn-${v}" onclick="app.recordAns(${v})" class="likert-btn ${selected === v ? 'selected' : ''} rounded-xl flex flex-row sm:flex-col gap-4 sm:gap-0 px-6 sm:px-0">
                                        <span class="text-xl sm:text-2xl font-black mb-0 sm:mb-1">${v}</span>
                                        <span class="text-[10px] sm:text-[8px] uppercase tracking-tighter font-bold opacity-60 text-left sm:text-center">${["Strongly Disagree","Disagree","Neutral","Agree","Strongly Agree"][v-1]}</span>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="mt-6 flex flex-col items-center">
                                <button onclick="app.notSureClicked()" class="not-sure-btn ${selected === -1 ? 'flash' : ''}" id="not-sure-btn">Not sure / Prefer not to answer</button>
                            </div>
                            
                            <!-- Internal Navigation Arrows -->
                            <div class="absolute bottom-6 left-6 right-6 flex justify-between pointer-events-none">
                                <button onclick="app.prev()" class="nav-icon-btn pointer-events-auto ${!hasPreviousAnswered ? 'disabled' : ''}">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <button onclick="app.nextManual()" class="nav-icon-btn pointer-events-auto ${!isCurrentAnswered || this.state.currentIdx === allQuestions.length - 1 ? 'disabled' : ''}">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            `;
        },

        renderResults(p) {
            let record = this.state.responses.find(r => r.id === this.state.surveyId);
            if (!record && this.state.answers) {
                const processedResults = this.processResults();
                record = { 
                    scores: processedResults.scores, 
                    overall: processedResults.overall, 
                    quality: processedResults.quality,
                    user: this.state.user 
                };
            }

            const history = this.getTrendData(this.state.user.email);
            
            // Generate quality flags display HTML
            const qualityFlagsHtml = record.quality ? `
                <div class="glass-card p-6 rounded-[2rem] mt-8">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Data Quality Indicators</div>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <div class="w-3 h-3 rounded-full mt-1 flex-shrink-0 ${record.quality.tooFast ? 'bg-amber-500' : 'bg-teal-500'}"></div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-slate-200 mb-1">Response Time Quality</div>
                                <div class="text-xs text-slate-400">
                                    ${record.quality.tooFast ? 
                                        '<span class="text-amber-400 font-semibold">⚠ Flagged:</span> Survey completed in less than 120 seconds. Rapid responses may indicate insufficient reflection time.' : 
                                        '<span class="text-teal-400 font-semibold">✓ Normal:</span> Response timing appears adequate for thoughtful consideration.'}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-3 h-3 rounded-full mt-1 flex-shrink-0 ${record.quality.straightline ? 'bg-amber-500' : 'bg-teal-500'}"></div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-slate-200 mb-1">Response Pattern Quality</div>
                                <div class="text-xs text-slate-400">
                                    ${record.quality.straightline ? 
                                        '<span class="text-amber-400 font-semibold">⚠ Flagged:</span> Detected 10+ consecutive identical responses. May indicate lack of engagement or satisficing behavior.' : 
                                        '<span class="text-teal-400 font-semibold">✓ Normal:</span> Response patterns show appropriate variability and engagement.'}
                                </div>
                            </div>
                        </div>
                        ${record.quality.insufficientOverall ? `
                        <div class="flex items-start gap-3">
                            <div class="w-3 h-3 rounded-full mt-1 flex-shrink-0 bg-rose-500"></div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-slate-200 mb-1">Survey Completeness</div>
                                <div class="text-xs text-slate-400">
                                    <span class="text-rose-400 font-semibold">⚠ Insufficient:</span> Less than 50% of items answered. Overall score has been adjusted accordingly.
                                </div>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <div class="text-[9px] text-slate-500 leading-relaxed">
                            <strong>Note:</strong> These indicators help assess response validity. Flagged items suggest reviewing the results with caution and may warrant retaking the assessment under optimal conditions.
                        </div>
                    </div>
                </div>
            ` : '';
            
            p.innerHTML = `
                <div class="py-6 space-y-12">
                    <div class="text-center relative">
                        ${this.state.viewingHistory ? `<button onclick="app.navigate('userHistory')" class="absolute left-0 top-0 bg-white/5 border border-white/10 hover:bg-white/10 px-6 py-3 rounded-full text-[10px] font-bold uppercase tracking-widest transition"><i class="fa-solid fa-arrow-left mr-2"></i>Back to History</button>` : ''}
                        
                        <div class="mb-4 text-[10px] font-bold text-cyan-500 tracking-[0.4em] uppercase pt-2">Diagnostic Prepared for:</div>
                        <h2 class="text-5xl font-extrabold mb-2 serif italic text-white">${this.state.user.name}</h2>
                        <div class="max-w-2xl mx-auto bg-white/5 p-6 rounded-2xl mt-8">
                            <div class="text-7xl font-black text-white mb-2">${record.overall}%</div>
                            <p class="text-sm font-bold text-cyan-400 uppercase tracking-widest mb-4">Maturity Status: ${this.getClass(record.overall)}</p>
                            <p class="text-xs text-slate-400 leading-relaxed serif italic">
                                "Your profile reflects a ${this.getClass(record.overall).toLowerCase()} level of AI alignment. This diagnostic indicates strength in ${record.scores.sort((a,b)=>b.score-a.score)[0].name} and identifies specific developmental opportunities."
                            </p>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-10">
                        <div class="space-y-8 sticky top-24 h-fit">
                            <div class="glass-card p-10 rounded-[2.5rem]">
                                <div class="aspect-square"><canvas id="final-radar"></canvas></div>
                            </div>
                            
                            ${qualityFlagsHtml}
                            
                             <div class="glass-card p-8 rounded-[2rem]">
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Historic Trend</div>
                                <div class="h-[250px]"><canvas id="trend-canvas-screen"></canvas></div>
                            </div>

                            <div class="mt-8">
                                <button onclick="app.downloadPDF()" class="w-full bg-white text-slate-950 font-black py-6 rounded-2xl hover:bg-cyan-400 transition-all flex items-center justify-center gap-4 uppercase tracking-widest text-xs shadow-xl">
                                    <i class="fa-solid fa-file-pdf text-xl"></i> Export Comprehensive Report
                                </button>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <h3 class="text-xs font-bold uppercase tracking-widest text-slate-500 border-b border-white/5 pb-2">Dimension Scores</h3>
                            <div class="grid gap-4">
                                ${record.scores.map(s => `
                                    <div class="glass-card p-6 rounded-2xl border-l-4 ${s.score >= 75 ? 'border-teal-500' : (s.score >= 50 ? 'border-cyan-500' : 'border-rose-500')}">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="text-xs font-bold text-slate-200 uppercase">${s.name}</div>
                                            <div class="text-2xl font-black text-white">${s.score}%</div>
                                        </div>
                                        <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                                            <div class="h-full ${s.score >= 75 ? 'bg-teal-500' : (s.score >= 50 ? 'bg-cyan-500' : 'bg-rose-500')}" style="width: ${s.score}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                this.drawRadar('final-radar', record.scores);
                this.drawTrend('trend-canvas-screen', history);
            }, 120);
        },

        renderAdmin(p) {
            if (!this.state.isAdmin) {
                p.innerHTML = `
                    <div class="py-6 md:py-10">
                        <div class="max-w-md mx-auto glass-card p-12 rounded-[3rem] text-center">
                            <h2 class="text-xl font-bold mb-8 uppercase tracking-widest">Admin Entry</h2>
                            <input type="password" id="admin-p" class="w-full bg-slate-950/50 border border-white/10 p-5 rounded-2xl mb-6 outline-none focus:border-cyan-500 text-center text-3xl tracking-[0.5em]" placeholder="••••">
                            <button onclick="app.login()" class="w-full bg-cyan-700 text-white font-black py-5 rounded-2xl hover:bg-cyan-600 transition-all uppercase tracking-widest text-xs">Authorize</button>
                        </div>
                    </div>
                `;
                return;
            }
            p.innerHTML = `
                <div class="py-6 md:py-10">
                    <div class="space-y-8">
                        <div class="flex flex-col md:flex-row justify-between items-end border-b border-white/5 pb-6 gap-4">
                            <h2 class="text-4xl font-extrabold uppercase">Diagnostic <span class="title-instinct">Console</span></h2>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="app.showShareModal()" class="bg-indigo-600 text-white px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest"><i class="fa-solid fa-share-nodes mr-2"></i>Distribute</button>
                                <button onclick="app.exportMasterCSV()" class="bg-transparent border border-white/20 text-slate-300 hover:bg-white/5 px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest">Download Master CSV for Psychometrics</button>
                                <button onclick="app.exportCSV()" class="bg-slate-800 text-white px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest">Simple Export</button>
                                <button onclick="app.adminTeamDownload()" class="bg-green-600 text-white px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest"><i class="fa-solid fa-file-pdf mr-2"></i>Team Report</button>
                                <button onclick="app.resetSystem()" class="bg-rose-900/40 text-rose-400 px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest">System Reset</button>
                            </div>
                        </div>
                        <div class="glass-card rounded-[2rem] overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white/5 text-[10px] uppercase font-bold text-slate-500 tracking-widest">
                                    <tr><th class="px-6 py-4">Subject</th><th class="px-6 py-4 text-center">Survey ID</th><th class="px-6 py-4 text-center">Country</th><th class="px-6 py-4 text-center">Device</th><th class="px-6 py-4 text-center">Score</th><th class="px-6 py-4 text-right">Actions</th></tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${this.state.responses.map((r, i) => `
                                        <tr class="hover:bg-white/5 transition">
                                            <td class="px-6 py-6"><div class="font-bold text-slate-200">${r.user.name}</div><div class="text-[9px] font-mono text-slate-600">${r.user.email}</div></td>
                                            <td class="px-6 py-6 text-center"><div class="text-[9px] font-mono text-slate-400">${r.id}</div></td>
                                            <td class="px-6 py-6 text-center"><div class="text-[9px] font-mono text-slate-400">${r.user.country || '—'}</div></td>
                                            <td class="px-6 py-6 text-center"><div class="text-[9px] font-mono text-slate-400">${r.device ? (r.device.length>40 ? r.device.substring(0,40)+'...' : r.device) : '—'}</div></td>
                                            <td class="px-6 py-6 text-center"><span class="font-black ${r.overall >= 75 ? 'text-teal-400' : (r.overall >= 50 ? 'text-cyan-400' : 'text-rose-400')}">${r.overall}%</span></td>
                                            <td class="px-6 py-6 text-right space-x-4">
                                                <button onclick="app.retake(${i})" class="text-[9px] font-bold text-amber-500 uppercase">Retake</button>
                                                <button onclick="app.adminIndivDownload(${i})" class="text-slate-500 hover:text-cyan-400"><i class="fa-solid fa-file-pdf"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        showShareModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'share-modal';
            overlay.innerHTML = `
                <div class="glass-card p-8 rounded-2xl max-w-sm w-full text-center">
                    <h3 class="text-xl font-bold mb-4 uppercase">Distribute Survey</h3>
                    <div class="grid gap-3">
                        <button onclick="app.shareByEmail()" class="bg-white/5 p-3 rounded-xl hover:bg-white/10"><i class="fa-solid fa-envelope mr-2 text-cyan-400"></i> Email Invite</button>
                        <button onclick="app.shareByWhatsApp()" class="bg-white/5 p-3 rounded-xl hover:bg-white/10"><i class="fa-brands fa-whatsapp mr-2 text-emerald-400"></i> WhatsApp</button>
                    </div>
                    <button onclick="document.getElementById('share-modal').remove()" class="mt-6 text-xs text-slate-400 uppercase font-bold">Close</button>
                </div>
            `;
            document.body.appendChild(overlay);
        },

        shareByEmail() {
            const recipient = prompt("Enter recipient email:");
            if (!recipient) return;
            const subject = "AI Instinct Index® Survey Invite";
            const body = `Please participate in the AI Instinct Index® Behavioral Diagnostic: ${window.location.href}`;
            window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        },

        shareByWhatsApp() {
            const num = prompt("Enter phone number with country code (e.g., 919876543210):");
            if (!num) return;
            const msg = `Join the AI Instinct Index® Behavioral Diagnostic Survey: ${window.location.href}`;
            window.open(`https://wa.me/${num.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
        },

        navigate(v) { 
            // Reset survey state when navigating to hero for a fresh start
            if (v === 'hero') {
                this.state.user = null;
                this.state.answers = new Array(allQuestions.length).fill(null);
                this.state.currentIdx = 0;
                this.state.viewingHistory = false;
                this.state.isTransitioning = false;
                this.state.surveyId = 'RES-' + Math.random().toString(36).substr(2,8).toUpperCase();
            }
            this.state.view = v; 
            this.updateNav(); 
            this.render();
            
            // Scroll to top smoothly on page transition
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        login() { const v = document.getElementById('admin-p'); if (v && v.value === CONFIG.ADMIN_PASS) { this.state.isAdmin = true; this.navigate('admin'); } else alert('Invalid Credentials'); },

        logout() { this.state.isAdmin = false; this.navigate('hero'); },

        jumpTo(index) {
            // Only allow jumping to questions that have been answered
            // or to the first unanswered question in sequence
            if (this.state.answers[index] !== null) {
                this.state.currentIdx = index;
                this.render();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            // Allow jumping to first unanswered question if it's in sequence
            else {
                // Check if all questions before this index are answered
                let allPreviousAnswered = true;
                for (let i = 0; i < index; i++) {
                    if (this.state.answers[i] === null) {
                        allPreviousAnswered = false;
                        break;
                    }
                }
                if (allPreviousAnswered) {
                    this.state.currentIdx = index;
                    this.render();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        },

        recordAns(v) {
            if (this.state.isTransitioning) {
                console.warn('⚠️ Blocked: Already transitioning');
                return;
            }
            
            const currentQuestionIndex = this.state.currentIdx;
            const totalQuestions = allQuestions.length;
            const lastQuestionIndex = totalQuestions - 1;
            const isLastQuestion = (currentQuestionIndex === lastQuestionIndex);
            
            if (!this.state.answerTimes) this.state.answerTimes = new Array(totalQuestions).fill(null);
            this.state.answerTimes[currentQuestionIndex] = Date.now();
            this.state.answers[currentQuestionIndex] = v;
            
            // Visual marking logic...
            if (v === -1) {
                try {
                    const nsBtn = document.getElementById('not-sure-btn') || document.querySelector('.not-sure-btn');
                    if (nsBtn) nsBtn.classList.add('selected');
                    [1,2,3,4,5].forEach(i => { 
                        const b = document.getElementById(`btn-${i}`); 
                        if (b) b.classList.remove('selected'); 
                    });
                    _markNsnaForIndex(currentQuestionIndex);
                } catch(e) {}
            } else {
                const nsBtn2 = document.getElementById('not-sure-btn') || document.querySelector('.not-sure-btn');
                if (nsBtn2) nsBtn2.classList.remove('selected');
            }
            
            const btn = document.getElementById(`btn-${v}`);
            [1,2,3,4,5].forEach(i => {
                const b = document.getElementById(`btn-${i}`);
                if(b) b.classList.remove('selected');
            });
            if(btn) btn.classList.add('selected');
            
            if (v === -1) {
                const nb = document.getElementById('not-sure-btn');
                if (nb) { 
                    nb.classList.add('flash'); 
                    setTimeout(()=>nb.classList.remove('flash'), 300); 
                }
            }
            
            this.state.isTransitioning = true;
            
            if (isLastQuestion) {
                // Check if ALL questions are answered before allowing submission
                const allAnswered = this.state.answers.every(ans => ans !== null);
                
                if (!allAnswered) {
                    // Find first unanswered question
                    const firstUnanswered = this.state.answers.findIndex(ans => ans === null);
                    alert(`Please answer all questions before submitting. Question ${firstUnanswered + 1} is unanswered.`);
                    this.state.isTransitioning = false;
                    return;
                }
                
                const inner = document.getElementById('survey-inner');
                if (inner) inner.classList.add('fade-out');
                
                setTimeout(() => {
                    this.state.isTransitioning = false;
                    try { this.complete(); } catch(error) {
                        console.error('❌ ERROR in complete():', error);
                        setTimeout(() => {
                            try { this.complete(); } catch(retryError) {
                                alert('Survey submission encountered an error. Please contact support with ID: ' + this.state.surveyId);
                            }
                        }, 500);
                    }
                }, 250);
                
            } else {
                // Only advance to the immediate next question (sequential)
                const inner = document.getElementById('survey-inner');
                if (inner) inner.classList.add('fade-out');
                
                setTimeout(() => {
                    this.state.currentIdx++;
                    this.render();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setTimeout(() => {
                        const newInner = document.getElementById('survey-inner');
                        if (newInner) newInner.classList.remove('fade-out');
                        this.state.isTransitioning = false;
                    }, 50);
                }, 250);
            }
        },

        prev() { 
            if (this.state.currentIdx > 0 && !this.state.isTransitioning) {
                // Find the previous answered question
                let prevIdx = this.state.currentIdx - 1;
                while (prevIdx >= 0 && this.state.answers[prevIdx] === null) {
                    prevIdx--;
                }
                
                // Only navigate if we found an answered question
                if (prevIdx >= 0) {
                    this.state.isTransitioning = true;
                    const inner = document.getElementById('survey-inner');
                    if (inner) inner.classList.add('fade-out');
                    
                    setTimeout(() => {
                        this.state.currentIdx = prevIdx; 
                        this.render(); 
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                        setTimeout(() => {
                            const newInner = document.getElementById('survey-inner');
                            if (newInner) newInner.classList.remove('fade-out');
                            this.state.isTransitioning = false;
                        }, 50);
                    }, 250);
                }
            } 
        },

        // Manual Next button action
        nextManual() {
            // Only allow next if current question is answered
            if (this.state.answers[this.state.currentIdx] === null) {
                return; // Cannot proceed without answering current question
            }
            
            if (this.state.currentIdx < allQuestions.length - 1 && !this.state.isTransitioning) {
                // Only go to the immediate next question (sequential)
                this.state.isTransitioning = true;
                const inner = document.getElementById('survey-inner');
                if (inner) inner.classList.add('fade-out');
                
                setTimeout(() => {
                    this.state.currentIdx++; 
                    this.render(); 
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    setTimeout(() => {
                        const newInner = document.getElementById('survey-inner');
                        if (newInner) newInner.classList.remove('fade-out');
                        this.state.isTransitioning = false;
                    }, 50);
                }, 250);
            }
        },

        notSureClicked() { this.recordAns(-1); },

        retake(idx) {
            const r = this.state.responses[idx];
            if (!r) return;
            this.state.user = r.user;
            this.state.answers = new Array(allQuestions.length).fill(null);
            this.state.currentIdx = 0;
            this.state.isAdmin = false;
            this.navigate('reg');
        },

        resetSystem() {
            if (confirm('DANGER: This will delete ALL responses. Proceed?')) {
                localStorage.removeItem('ai_instinct_v8');
                this.state.responses = [];
                this.state.user = null;
                this.state.answers = new Array(allQuestions.length).fill(null);
                this.state.currentIdx = 0;
                this.state.isAdmin = false;
                this.navigate('reg');
            }
        },

        async complete() {
            try {
                const res = this.processResults();
                const deviceInfo = navigator.userAgent || navigator.platform || 'unknown';
                const record = { 
                    id: this.state.surveyId, 
                    user: this.state.user, 
                    device: deviceInfo, 
                    ...res, 
                    answers: this.state.answers,
                    answerTimes: this.state.answerTimes,
                    timestamp: new Date().toLocaleString() 
                };
                
                this.state.responses.push(record);
                localStorage.setItem('ai_instinct_v8', JSON.stringify(this.state.responses));
                
                try {
                    this.submitToGoogleSheet(record);
                } catch(gsError) {
                    console.error('⚠️ Google Sheet submission failed (non-critical):', gsError);
                }
                
                this.navigate('results');
                
                try { 
                    await this.generatePDF(record); 
                } catch(e) { 
                    console.error('⚠️ PDF generation failed (non-critical):', e); 
                }
                
            } catch(error) {
                console.error('Error in complete():', error);
                alert('An error occurred while submitting your survey. Your responses have been saved locally. Please screenshot this message and contact support.\n\nError ID: ' + this.state.surveyId + '\nError: ' + error.message);
                
                // Attempt to at least save to localStorage
                try {
                    const emergencyRecord = {
                        id: this.state.surveyId,
                        user: this.state.user,
                        answers: this.state.answers,
                        answerTimes: this.state.answerTimes,
                        timestamp: new Date().toLocaleString(),
                        error: error.message
                    };
                    localStorage.setItem('ai_instinct_emergency_' + this.state.surveyId, JSON.stringify(emergencyRecord));
                } catch(emergError) {
                    console.error('Emergency save also failed:', emergError);
                }
            }
        },

        submitToGoogleSheet(record) {
            // Validate record
            if (!record || !record.answers || !record.user) {
                return;
            }
            
            // Flatten the data structure
            const flatData = {
                // Metadata
                protocolId: record.id || 'UNKNOWN',
                name: record.user.name || '',
                email: record.user.email || '',
                country: record.user.country || '',
                timestamp: record.timestamp || new Date().toISOString(),
                device: record.device || 'unknown',
                
                // Overall Score
                overall_score: record.overall || 0
            };

            // Map Raw Item Responses (Q1 - Q46)
            if (record.answers && Array.isArray(record.answers)) {
                record.answers.forEach((ans, idx) => {
                    flatData[`Q${idx + 1}`] = ans !== null && ans !== undefined ? ans : '';
                });
            }

            // Map Timing Data (T1 - T46)
            const times = record.answerTimes || [];
            const totalQuestions = allQuestions.length;
            
            for (let i = 0; i < totalQuestions; i++) {
                if (i === 0) {
                    flatData[`T1`] = times[0] || 0;
                } else {
                    const curr = times[i];
                    const prev = times[i-1];
                    flatData[`T${i+1}`] = (curr && prev) ? (curr - prev) : 0;
                }
            }

            // Map Dimension Scores (Raw & Adjusted)
            if (record.scores && Array.isArray(record.scores)) {
                record.scores.forEach(s => {
                    const safeName = s.name.replace(/\s+/g, '_').replace(/&/g, 'and');
                    flatData[`${safeName}_raw`] = s.rawObserved !== undefined ? s.rawObserved : '';
                    flatData[`${safeName}_adjusted`] = s.adjusted !== undefined ? s.adjusted : '';
                    flatData[`${safeName}_nAnswered`] = s.nAnswered !== undefined ? s.nAnswered : '';
                    flatData[`${safeName}_score`] = s.score !== undefined ? s.score : '';
                });
            }

            // Map Quality Flags
            if (record.quality) {
                flatData['flag_tooFast'] = record.quality.tooFast || false;
                flatData['flag_straightline'] = record.quality.straightline || false;
                flatData['flag_insufficient'] = record.quality.insufficientOverall || false;
                flatData['completeness_pct'] = record.quality.completeness || 0;
            }

            // Map Cronbach's Alpha
            if (record.alphas && Array.isArray(record.alphas)) {
                record.alphas.forEach((alpha, idx) => {
                    flatData[`alpha_dim${idx}`] = alpha !== null && alpha !== undefined ? alpha : '';
                });
            }

            // Create the request payload
            const payload = JSON.stringify(flatData);

            // Send to Google Apps Script Web App
            // FIX: Use text/plain to avoid preflight options check which GAS hates
            fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                cache: "no-cache",
                headers: { 
                    "Content-Type": "text/plain;charset=utf-8"
                },
                body: payload
            })
            .then(response => {
                console.log("✅ Data sent to Google Sheet successfully!");
            })
            .catch(err => {
                console.error("❌ Google Sheet Sync Error:", err);
            });
        },

        
        // --- Added helper methods for robust scoring, psychometrics, and quality checks ---
        shrink(n, observedPct, K=3, prior=60) {
            if (!n || n <= 0) return prior;
            return ((n * observedPct) + (K * prior)) / (n + K);
        },

        computeCronbachAlphaForDimension(dIdx, responsesArray) {
            // responsesArray: array of response objects with 'answers' array (values 1-5, -1 for not-sure, null for missing)
            if (!responsesArray || !responsesArray.length) return null;
            const qIdxs = allQuestions.map((q,i) => q.dIdx === dIdx ? i : -1).filter(i => i !== -1);
            const k = qIdxs.length;
            if (k < 2) return null;
            // build item columns
            const rows = [];
            for (let r of responsesArray) {
                const row = [];
                let hasAny = false;
                for (let qi of qIdxs) {
                    const v = (r.answers && typeof r.answers[qi] !== 'undefined') ? r.answers[qi] : null;
                    // treat not-sure (-1) and null as NaN (missing)
                    if (v === -1 || v === null || typeof v === 'undefined') {
                        row.push(NaN);
                    } else {
                        row.push(Number(v));
                        hasAny = true;
                    }
                }
                if (hasAny) rows.push(row);
            }
            if (rows.length < 2) return null;
            // transpose and compute variances
            const itemVars = [];
            const itemMeans = [];
            for (let j=0;j<k;j++) {
                const col = rows.map(r => r[j]).filter(x => !isNaN(x));
                if (col.length < 2) return null;
                const mean = col.reduce((a,b) => a+b,0)/col.length;
                const varr = col.reduce((a,b) => a + Math.pow(b-mean,2),0)/(col.length-1);
                itemVars.push(varr);
                itemMeans.push(mean);
            }
            // compute total score variance (sum of item scores per row)
            const totals = rows.map(r => {
                let sum = 0;
                let count = 0;
                for (let j=0;j<k;j++) {
                    if (!isNaN(r[j])) { sum += r[j]; count++; }
                }
                // impute by mean for missing items in that row (simple mean imputation)
                if (count < k) {
                    const overallMeans = itemMeans;
                    for (let j=0;j<k;j++) {
                        if (isNaN(r[j])) sum += overallMeans[j];
                    }
                }
                return sum;
            });
            const meanTotal = totals.reduce((a,b)=>a+b,0)/totals.length;
            const totalVar = totals.reduce((a,b)=>a + Math.pow(b-meanTotal,2),0)/(totals.length-1);
            const sumItemVars = itemVars.reduce((a,b)=>a+b,0);
            const alpha = (k / (k-1)) * (1 - (sumItemVars / totalVar));
            return alpha;
        },

        computeQualityFlags() {
            const flags = { tooFast:false, straightline:false, lowAnsweredDims: [] };
            try {
                const times = this.state.answerTimes || [];
                const answeredIdxs = [];
                for (let i=0;i<allQuestions.length;i++){
                    const v = this.state.answers[i];
                    if (typeof v !== 'undefined' && v !== null && v !== -1) answeredIdxs.push(i);
                }
                // compute inter-response deltas for answered indices
                const deltas = [];
                let prev = null;
                for (let idx of answeredIdxs){
                    const t = this.state.answerTimes && this.state.answerTimes[idx] ? this.state.answerTimes[idx] : null;
                    if (t && prev) {
                        deltas.push(t - prev);
                    }
                    if (t) prev = t;
                }
                const toSeconds = arr => arr.map(x => x/1000);
                const median = arr => {
                    if (!arr.length) return null;
                    const a = arr.slice().sort((a,b)=>a-b);
                    const m = Math.floor(a.length/2);
                    return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
                };
                const deltasSec = toSeconds(deltas);
                const med = median(deltasSec);
                if (med !== null && med < 1.5) flags.tooFast = true;
                // total time
                const timeVals = (this.state.answerTimes || []).filter(x => x);
                if (timeVals.length >= 2) {
                    const totalSec = (Math.max(...timeVals) - Math.min(...timeVals))/1000;
                    // Explicit check: completion < 120 seconds as per methodology
                    if (totalSec < 120) flags.tooFast = true;
                    // Additional check: average time per item too low
                    if (totalSec < (answeredIdxs.length * 1.5)) flags.tooFast = true;
                }
                // straightlining: check for 10+ consecutive identical responses (per methodology)
                const vals = answeredIdxs.map(i => Number(this.state.answers[i]));
                if (vals.length >= 10) {
                    let maxConsecutive = 1;
                    let currentConsecutive = 1;
                    for (let i = 1; i < vals.length; i++) {
                        if (vals[i] === vals[i-1]) {
                            currentConsecutive++;
                            maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                        } else {
                            currentConsecutive = 1;
                        }
                    }
                    if (maxConsecutive >= 10) flags.straightline = true;
                }
                // low answered dims
                for (let dIdx=0; dIdx<dimensionsData.length; dIdx++){
                    const qIdxs = allQuestions.map((q,i) => q.dIdx === dIdx ? i : -1).filter(i => i !== -1);
                    const answered = qIdxs.filter(i => typeof this.state.answers[i] !== 'undefined' && this.state.answers[i] !== null && this.state.answers[i] !== -1).length;
                    const minAnswered = Math.max(1, Math.min(3, Math.ceil(qIdxs.length/2)));
                    if (answered < minAnswered) flags.lowAnsweredDims.push(dIdx);
                }
            } catch(e) {
                console.error('quality flag error', e);
            }
            return flags;
        },
        // --- end helpers ---
    


processResults() {
            const totalQuestions = allQuestions.length;
            const totalAnsweredAll = allQuestions.map((_,i) => {
                const v = (typeof this.state.answers[i] !== 'undefined') ? this.state.answers[i] : null;
                return (v === -1 || v === null || typeof v === 'undefined') ? 0 : 1;
            }).reduce((a,b)=>a+b,0);
            const answeredProportion = totalQuestions ? (totalAnsweredAll / totalQuestions) : 0;

            // shrink threshold: only apply shrinkage when nAnswered < shrinkThreshold (Option A)
            const shrinkThreshold = 4; // configurable: apply shrinkage only for very small nAnswered

            const scores = dimensionsData.map((d, dIdx) => {
                const qIdxs = allQuestions.map((q,i) => q.dIdx === dIdx ? i : -1).filter(i => i !== -1);
                const expectedCount = qIdxs.length;
                // collect valid numeric answers (1-5). Not-sure is -1, unanswered is null/undefined
                const vals = qIdxs.map(i => {
                    const v = (typeof this.state.answers[i] !== 'undefined') ? this.state.answers[i] : null;
                    if (v === -1 || v === null || typeof v === 'undefined') return null;
                    // CRITICAL FIX: Implement reverse scoring
                    const question = allQuestions[i];
                    return question.reverse ? (6 - Number(v)) : Number(v);
                }).filter(x => x !== null && !isNaN(x));
                const nAnswered = vals.length;
                const minAnswered = Math.max(1, Math.min(3, Math.ceil(qIdxs.length/2)));
                let observedPct = 0;
                let insufficient = false;
                if (nAnswered >= minAnswered) {
                    const sum = vals.reduce((a,b)=>a+b,0);
                    observedPct = Math.round((sum / (nAnswered * 5)) * 100);
                } else {
                    insufficient = true;
                    observedPct = nAnswered ? Math.round((vals.reduce((a,b)=>a+b,0) / (Math.max(1,nAnswered) * 5)) * 100) : 0;
                }
                // apply shrinkage (Option A & B)
                const baseK = (typeof d.shrinkK !== 'undefined') ? d.shrinkK : 3;
                const prior = (typeof d.prior !== 'undefined') ? d.prior : 60;

                // Attempt to obtain Cronbach alpha for this dimension (from local storage or precomputed d.alpha)
                let alpha = null;
                try {
                    if (typeof d.alpha !== 'undefined' && d.alpha !== null) alpha = d.alpha;
                    const resp = localStorage.getItem('responses') ? JSON.parse(localStorage.getItem('responses')) : null;
                    if (resp && resp.length >= 2) {
                        const computed = this.computeCronbachAlphaForDimension(dIdx, resp);
                        if (computed !== null) alpha = computed;
                    }
                } catch(e){ console.error('alpha load error', e); }

                // Adaptive K: scale down K when alpha is high (Option B)
                let K_adj = baseK;
                if (alpha !== null && !isNaN(alpha)) {
                    // ensure alpha in [0,1]
                    if (alpha < 0) alpha = 0;
                    if (alpha > 1) alpha = 1;
                    K_adj = baseK * (1 - alpha); // if alpha=1 -> K_adj=0 (no shrink), alpha=0 -> K_adj=baseK
                }

                // Only apply shrinkage when nAnswered < shrinkThreshold (Option A). Otherwise use observedPct.
                let adjusted;
                if (nAnswered >= shrinkThreshold) {
                    adjusted = observedPct; // enough data: use raw observed
                } else {
                    adjusted = Math.round(this.shrink(nAnswered, observedPct, K_adj, prior));
                }

                const score = insufficient ? null : adjusted;
                // weight = proportion of items answered in this dimension (0..1)
                const weight = expectedCount ? (nAnswered / expectedCount) : 0;
                return { ...d, score, rawObserved: observedPct, adjusted, nAnswered, insufficient, expectedCount, weight, alpha };
            });

            // Compute weighted overall using per-dimension weights (proportion answered in each dim)
            const weightedNumerator = scores.reduce((acc, s) => {
                if (s.score !== null && typeof s.score !== 'undefined') return acc + (s.score * s.weight);
                return acc;
            }, 0);
            const weightDenominator = scores.reduce((acc, s) => acc + s.weight, 0);
            let weightedOverall = (weightDenominator > 0) ? Math.round(weightedNumerator / weightDenominator) : null;

            // If too many items are missing (answeredProportion < 0.5), penalize overall and flag insufficientOverall
            const quality = this.computeQualityFlags();
            quality.insufficientOverall = false;
            if (answeredProportion < 0.5) {
                quality.insufficientOverall = true;
                // Penalize by scaling by proportion answered (so many unanswered reduces the overall)
                if (weightedOverall !== null) {
                    weightedOverall = Math.round(weightedOverall * answeredProportion);
                }
            }

            // Also, if no dimension has sufficient answers, overall is null
            const anyValid = scores.some(s => s.score !== null && typeof s.score !== 'undefined');
            const overall = anyValid ? weightedOverall : null;

            // compute Cronbach alpha per dimension if there is a responses bank in localStorage
            let alphas = null;
            try {
                const resp = localStorage.getItem('responses') ? JSON.parse(localStorage.getItem('responses')) : null;
                if (resp && resp.length >= 2) {
                    alphas = dimensionsData.map((d, dIdx) => {
                        const a = this.computeCronbachAlphaForDimension(dIdx, resp);
                        return (a === null) ? null : Number(a.toFixed(3));
                    });
                }
            } catch(e) { console.error(e); }

            return { scores, overall, quality, alphas, totalAnsweredAll, answeredProportion };
        }


,

        getTrendData(email) {
            const e = email.toLowerCase().trim();
            const sorted = this.state.responses
                .filter(r => r.user.email.toLowerCase().trim() === e)
                .sort((a,b) => {
                    const dA = new Date(a.timestamp).getTime() || 0;
                    const dB = new Date(b.timestamp).getTime() || 0;
                    return dA - dB;
                });
            
            return sorted.map((r, i) => ({
                label: r.timestamp.split(',')[0],
                score: r.overall,
                index: i + 1
            }));
        },

        getClass(s) { if (s >= 75) return "Strong"; if (s >= 50) return "Moderate"; return "Emerging"; },

        getSuggestions(dimIndex, score, dimName) {
            let pool = [];
            if (score >= 75) pool = SUGGESTIONS_POOL.STRONG;
            else if (score >= 50) pool = SUGGESTIONS_POOL.MODERATE;
            else pool = SUGGESTIONS_POOL.EMERGING;
            const len = pool.length;
            const indices = [ dimIndex % len, (dimIndex + 1) % len, (dimIndex + 2) % len ];
            return indices.map(i => pool[i].replace(/\[DIMENSION\]/g, dimName));
        },

        drawTrend(canvasId, historyData, forPdf = false, forHistoryPanel = false) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            
            // Clean up existing chart instance based on context
            if (forPdf && pdfTrendChart) pdfTrendChart.destroy();
            else if (forHistoryPanel && historyTrendChart) { historyTrendChart.destroy(); }
            else if (!forPdf && !forHistoryPanel && trendChart) trendChart.destroy();

            const gridColor = forPdf ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)';
            const textColor = forPdf ? '#64748b' : '#94a3b8';
            const lineColor = '#00f0ff';
            
            const cfg = {
                type: 'line',
                data: {
                    labels: historyData.map(h => h.label),
                    datasets: [{
                        label: 'Overall Score',
                        data: historyData.map(h => h.score),
                        borderColor: lineColor,
                        backgroundColor: 'rgba(0, 240, 255, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: lineColor,
                        pointRadius: 6,
                        tension: 0.3,
                        fill: true
                    }]
                },
                plugins: [{
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        ctx.font = forPdf ? 'bold 12px Helvetica' : 'bold 10px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const data = dataset.data[index];
                                ctx.fillStyle = data >= 75 ? '#2dd4bf' : (data >= 50 ? '#00f0ff' : '#f43f5e');
                                ctx.fillText(data + '%', element.x, element.y - 12);
                            });
                        });
                    }
                }],
                options: {
                    responsive: !forPdf, 
                    maintainAspectRatio: false,
                    animation: !forPdf,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: !forPdf }
                    },
                    scales: {
                        y: {
                            min: 0, max: 100,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            };
            
            const chartInstance = new Chart(ctx, cfg);
            if (forPdf) pdfTrendChart = chartInstance;
            else if (forHistoryPanel) historyTrendChart = chartInstance;
            else trendChart = chartInstance;
            
            return chartInstance;
        },

        drawRadar(canvasId, scores, forPdf = false) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            if (forPdf && pdfRadarChart) pdfRadarChart.destroy();
            else if (!forPdf && radarChart) radarChart.destroy();

            const getLabelColor = (val) => {
                if (val >= 75) return '#2dd4bf'; 
                if (val >= 50) return '#00f0ff'; 
                return '#f43f5e'; 
            };

            const labelsWithPct = scores.map(s => [s.name, `${s.score}%`]); 
            
            const cfg = {
                type: 'radar',
                data: {
                    labels: labelsWithPct,
                    datasets: [{
                        label: 'Score',
                        data: scores.map(s => s.score),
                        backgroundColor: forPdf ? 'rgba(45, 212, 191, 0.3)' : 'rgba(0,240,255,0.15)',
                        borderColor: forPdf ? '#0d9488' : '#00f0ff',
                        borderWidth: forPdf ? 4 : 3,
                        pointBackgroundColor: forPdf ? '#fff' : '#00f0ff', 
                        pointBorderColor: forPdf ? '#0d9488' : '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointRadius: forPdf ? 8 : 6
                    }]
                },
                options: {
                    animation: !forPdf,
                    responsive: !forPdf, 
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            min: 0, max: 100,
                            ticks: { 
                                display: true,
                                stepSize: 20,
                                backdropColor: 'transparent',
                                color: forPdf ? '#64748b' : 'rgba(255,255,255,0.3)',
                                font: { size: forPdf ? 22 : 16, weight: 'bold' } 
                            }, 
                            grid: { 
                                color: forPdf ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.05)',
                                circular: true,
                                lineWidth: 2 
                            },
                            pointLabels: { 
                                color: (ctx) => {
                                    const index = ctx.index;
                                    const score = scores[index].score;
                                    return getLabelColor(score);
                                },
                                font: { 
                                    size: forPdf ? 28 : 20, 
                                    weight: forPdf ? 'normal' : '900',
                                    family: 'Helvetica'
                                },
                                callback: (label) => label 
                            },
                            angleLines: { color: forPdf ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.05)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            };
            const chartInstance = new Chart(ctx, cfg);
            if (forPdf) pdfRadarChart = chartInstance; else radarChart = chartInstance;
            return chartInstance;
        },

        async generatePDF(record) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait', compress: true });

            const colors = {
                slate900: [15, 23, 42],
                slate800: [30, 41, 59],
                slate700: [51, 65, 85],
                slate600: [71, 85, 105],
                slate500: [100, 116, 139],
                slate400: [148, 163, 184],
                slate100: [241, 245, 249],
                cyan500: [6, 182, 212],
                teal500: [20, 184, 166],
                rose500: [244, 63, 94],
                white: [255, 255, 255],
                cardBg: [250, 250, 250],
                grayBg: [235, 237, 240] 
            };

            const layout = { margin: 15, width: 210, height: 297, contentW: 180, lineH: 5 };

            // Elegant date formatter for Indian format (DD/MM/YYYY)
            const formatDate = (date) => {
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            };

            const setFont = (type = 'normal', size = 10, color = colors.slate700) => {
                doc.setFont('helvetica', type);
                doc.setFontSize(size);
                doc.setTextColor(...color);
            };

            // Professional alignment helper
            const addBrandedText = (docObj, text, x, y, size, align = 'left') => {
                const mainText = text.replace('®','');
                docObj.text(mainText, x, y, { align: align });
            }

            const addHeader = (title) => {
                doc.setFillColor(...colors.slate900);
                doc.rect(0, 0, layout.width, 20, 'F');
                setFont('bold', 12, colors.white);
                
                // Header Logo
                doc.text('AI INSTINCT INDEX', layout.margin, 14);
                // Registered Trademark: Small R inside O, raised towards right side top of X
                const w = doc.getTextWidth('AI INSTINCT INDEX');
                doc.setFontSize(7); 
                doc.text('®', layout.margin + w + 0.5, 11); 

                setFont('normal', 10, colors.cyan500);
                const pageInfo = `Page ${doc.internal.getNumberOfPages()}`;
                doc.text(pageInfo, layout.width - layout.margin, 14, { align: 'right' });
            };

            const addFooter = () => {
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    if (i === 1) continue;
                    setFont('normal', 8, colors.slate500);
                    // Updated Footer Branding
                    doc.text('AI INSTINCT INDEX® - 11 Dimensions Behavioural Readiness Assessment I sreejith@futureowork.com', layout.margin, layout.height - 10);
                    doc.text(`Page ${i}`, layout.width - layout.margin, layout.height - 10, { align: 'right' });
                }
            };

            const writeWrapped = (txt, x, y, maxW, lineHeight = 5, color = colors.slate700, size=9) => {
                setFont('normal', size, color);
                const lines = doc.splitTextToSize(txt, maxW);
                doc.text(lines, x, y);
                return lines.length * lineHeight;
            };

            // --- PAGE 1: COVER ---
            doc.setFillColor(...colors.slate900);
            doc.rect(0, 0, layout.width, layout.height, 'F');
            doc.setDrawColor(...colors.cyan500);
            doc.setLineWidth(0.5);
            doc.circle(layout.width + 20, 50, 80, 'S');
            doc.circle(layout.width + 20, 50, 70, 'S');
            doc.setFillColor(...colors.slate800);
            doc.circle(-20, layout.height - 50, 60, 'F');

            let y = 80;
            setFont('bold', 12, colors.cyan500);
            doc.text('BEHAVIORAL DIAGNOSTIC REPORT', layout.margin, y, null, null, "left");
            y += 15;
            setFont('bold', 42, colors.white);
            doc.text('AI INSTINCT', layout.margin, y);
            y += 15;
            
            // Branding: AI INSTINCT INDEX® (Raised ® on X)
            doc.text('INDEX', layout.margin, y);
            const titleW = doc.getTextWidth('INDEX');
            doc.setFontSize(24); 
            // Position ® tightly after INDEX, raised near the top of X
            doc.text('®', layout.margin + titleW + 0.5, y - 5);
            doc.setFontSize(42); 

            y += 25;
            setFont('normal', 14, colors.slate500);
            doc.text('Prepared for:', layout.margin, y);
            y += 10;
            setFont('bold', 22, colors.white);
            doc.text(record.user.name.toUpperCase(), layout.margin, y);
            y += 8;
            setFont('normal', 11, colors.cyan500);
            doc.text(record.user.email, layout.margin, y);

            y += 40;
            const scoreSize = 30;
            const scoreColor = record.overall >= 75 ? colors.teal500 : (record.overall >= 50 ? colors.cyan500 : colors.rose500);
            doc.setDrawColor(...scoreColor);
            doc.setLineWidth(2);
            doc.circle(layout.margin + scoreSize, y + scoreSize, scoreSize, 'S');
            setFont('bold', 28, scoreColor);
            doc.text(`${record.overall}%`, layout.margin + scoreSize, y + scoreSize + 3, {align: 'center'});
            const classification = record.overall >= 75 ? "STRONG" : (record.overall >= 50 ? "MODERATE" : "EMERGING");
            setFont('bold', 14, scoreColor);
            doc.text(classification, layout.margin + scoreSize, y + scoreSize + 15, {align: 'center'});
            setFont('bold', 10, colors.slate500);
            doc.text('OVERALL READINESS', layout.margin + scoreSize, y + (scoreSize*2) + 12, {align: 'center'});
            
            // Cover Page Footer Text (Aligned with Date)
            const footerY = layout.height - 15;
            setFont('normal', 10, colors.slate400);
            doc.text(formatDate(new Date()), layout.width - layout.margin, footerY, { align: 'right' });
            setFont('bold', 9, colors.slate500);
            doc.text('11 Dimensions Behavioural Readiness Assessment I Future of Work AI Labs I sreejith@futureowork.com', layout.margin, footerY);

            // --- PAGE 2: SUMMARY ---
            doc.addPage();
            addHeader();
            y = 35;
            setFont('bold', 16, colors.slate900);
            doc.text('EXECUTIVE SUMMARY', layout.margin, y);
            y += 10;
            setFont('bold', 11, colors.slate800);
            doc.text("This is not a judgment of performance. It is a diagnostic for readiness.", layout.margin, y);
            y += 10; // Slightly tighter

            const col1W = 110; 
            const col2X = layout.margin + col1W + 15;
            let textEndY = y;
            const prefix = [
                "This report assesses behavioral readiness for AI adoption — not technical capability.",
                "Most AI initiatives fail because of human behavior, not technology. This assessment evaluates how individuals and teams engage with AI across 11 critical behavioral dimensions.",
                "Your results highlight natural acceleration points, potential friction areas, and specific behavioral levers for leadership focus."
            ];
            prefix.forEach(p => {
                const h = writeWrapped(p, layout.margin, textEndY, col1W, 5, colors.slate700, 10);
                textEndY += h + 3; // Tighter paragraph spacing
            });

            // Compact Key Area
            let keyY = y; 
            doc.setFillColor(...colors.slate100);
            doc.roundedRect(col2X - 5, keyY - 5, 60, 45, 3, 3, 'F');
            const drawKeyItem = (color, label, range, ky) => {
                doc.setFillColor(...color);
                doc.circle(col2X, ky - 1, 2, 'F');
                setFont('bold', 9, colors.slate800);
                doc.text(label, col2X + 5, ky);
                setFont('normal', 8, colors.slate500);
                doc.text(range, col2X + 5, ky + 4);
            };
            drawKeyItem(colors.teal500, "STRONG", "Scores ≥ 75%", keyY + 5);
            drawKeyItem(colors.cyan500, "MODERATE", "Scores 50-74%", keyY + 17);
            drawKeyItem(colors.rose500, "EMERGING", "Scores < 50%", keyY + 29);
            
            // Move Radar UP by reducing the gap after text
            y = Math.max(textEndY, keyY + 45) + 5; 

            try {
                this.drawRadar && this.drawRadar('radar-canvas', record.scores, true);
                await new Promise(r => setTimeout(r, 600));
                const canvas = document.getElementById('radar-canvas');
                if (canvas) {
                    const img = canvas.toDataURL('image/png');
                    // Slightly tighter image size to ensure boxes fit
                    const imgSize = 110; 
                    const xPos = (layout.width - imgSize) / 2;
                    doc.addImage(img, 'PNG', xPos, y, imgSize, imgSize);
                    y += imgSize + 5; // Reduced gap after radar
                }
            } catch(e) { console.error("Radar error", e); y += 10; }

            // === DATA QUALITY INDICATORS SECTION ===
            // Add quality flags below radar chart
            if (record.quality) {
                const qFlags = record.quality;
                const hasFlags = qFlags.tooFast || qFlags.straightline || qFlags.insufficientOverall;
                
                if (hasFlags || true) {  // Always show section
                    // Title
                    setFont('bold', 10, colors.slate800);
                    doc.text('DATA QUALITY INDICATORS', layout.margin, y);
                    y += 5;
                    
                    // Box background
                    doc.setFillColor(...colors.grayBg);
                    const boxHeight = hasFlags ? 35 : 20;
                    doc.roundedRect(layout.margin, y, layout.contentW, boxHeight, 2, 2, 'F');
                    y += 5;
                    
                    // Time Quality Flag
                    const timeIcon = qFlags.tooFast ? '⚠' : '✓';
                    const timeColor = qFlags.tooFast ? colors.rose500 : colors.teal500;
                    doc.setFillColor(...timeColor);
                    doc.circle(layout.margin + 3, y - 1, 1.5, 'F');
                    setFont('bold', 8, colors.slate900);
                    doc.text('Response Time Quality:', layout.margin + 7, y);
                    setFont('normal', 7, colors.slate700);
                    const timeText = qFlags.tooFast ? 
                        'Flagged: Survey completed in <120 seconds. Rapid completion may indicate insufficient reflection.' : 
                        'Normal: Response timing appears adequate for thoughtful consideration.';
                    writeWrapped(timeText, layout.margin + 7, y + 3, layout.contentW - 10, 3.5, colors.slate700, 7);
                    y += 10;
                    
                    // Straightlining Flag
                    const slIcon = qFlags.straightline ? '⚠' : '✓';
                    const slColor = qFlags.straightline ? colors.rose500 : colors.teal500;
                    doc.setFillColor(...slColor);
                    doc.circle(layout.margin + 3, y - 1, 1.5, 'F');
                    setFont('bold', 8, colors.slate900);
                    doc.text('Response Pattern Quality:', layout.margin + 7, y);
                    setFont('normal', 7, colors.slate700);
                    const slText = qFlags.straightline ? 
                        'Flagged: Detected ≥10 consecutive identical responses. May indicate lack of engagement.' : 
                        'Normal: Response patterns show appropriate variability and engagement.';
                    writeWrapped(slText, layout.margin + 7, y + 3, layout.contentW - 10, 3.5, colors.slate700, 7);
                    y += 10;
                    
                    // Insufficient data flag (if applicable)
                    if (qFlags.insufficientOverall) {
                        doc.setFillColor(...colors.rose500);
                        doc.circle(layout.margin + 3, y - 1, 1.5, 'F');
                        setFont('bold', 8, colors.slate900);
                        doc.text('Survey Completeness:', layout.margin + 7, y);
                        setFont('normal', 7, colors.slate700);
                        writeWrapped('Insufficient: Less than 50% of items answered. Overall score has been adjusted.', layout.margin + 7, y + 3, layout.contentW - 10, 3.5, colors.slate700, 7);
                        y += 10;
                    }
                    
                    // Note
                    setFont('italic', 6, colors.slate600);
                    writeWrapped('Note: These indicators help assess response validity. Flagged items suggest reviewing results with caution.', layout.margin + 3, y + 2, layout.contentW - 6, 3, colors.slate600, 6);
                    y += hasFlags ? 10 : 5;
                }
            }

            const sorted = [...record.scores].sort((a,b) => b.score - a.score);
            const top3 = sorted.slice(0, 3);
            const low3 = sorted.slice(-3).reverse();
            const drawStatBox = (title, items, x, color) => {
                // Ensure boxes fit within page minus footer margin
                if (y + 45 > layout.height - 20) return; 
                doc.setFillColor(...colors.cardBg);
                doc.roundedRect(x, y, 85, 45, 3, 3, 'F');
                doc.setDrawColor(...colors.slate100);
                doc.rect(x, y, 85, 45, 'S');
                doc.setFillColor(...color);
                doc.rect(x, y, 85, 2, 'F');
                setFont('bold', 10, colors.slate900);
                doc.text(title, x + 5, y + 10);
                let iy = y + 18;
                items.forEach(item => {
                    setFont('bold', 9, color);
                    doc.text(`${item.score}%`, x + 5, iy);
                    setFont('normal', 9, colors.slate700);
                    doc.text(item.name, x + 16, iy);
                    iy += 8;
                });
            };
            
            // Draw boxes
            drawStatBox("TOP STRENGTHS", top3, layout.margin, colors.teal500);
            drawStatBox("DEVELOPMENT PRIORITIES", low3, layout.width/2 + 5, colors.rose500);

            // --- PAGES 3+: DIMENSIONS ---
            doc.addPage();
            addHeader();
            y = 35;
            setFont('bold', 16, colors.slate900);
            doc.text('DETAILED ANALYSIS', layout.margin, y);
            y += 14;

            record.scores.forEach((s, i) => {
                const checklistItems = this.getSuggestions(i, s.score, s.name);

                // Check if we need a new page - more conservative check
                if (y + 105 > layout.height - 20) {
                    doc.addPage();
                    addHeader();
                    y = 35;
                }

                const boxStartY = y;
                const scoreCol = s.score >= 75 
                    ? colors.teal500 
                    : (s.score >= 50 ? colors.cyan500 : colors.rose500);

                // Readiness classification with color coding
                let classification = 'Emerging';
                let classColor = colors.rose500;
                if (typeof s.score === 'number') {
                    if (s.score >= 75) {
                        classification = 'Strong';
                        classColor = colors.teal500;
                    } else if (s.score >= 50) {
                        classification = 'Moderate';
                        classColor = colors.cyan500;
                    }
                }

                // --- Dimension heading inside box ---
                let contentY = boxStartY + 8;
                setFont('bold', 12, colors.slate900);
                doc.text(s.name.toUpperCase(), layout.margin + 4, contentY);
                
                // Score badge - positioned on the right
                doc.setFillColor(...scoreCol);
                doc.roundedRect(layout.width - layout.margin - 20, boxStartY + 4, 16, 9, 2, 2, 'F');
                setFont('bold', 9, colors.white);
                doc.text(`${s.score}%`, layout.width - layout.margin - 12, boxStartY + 9.5, {align: 'center'});
                
                // Classification with color coding - positioned next to score
                setFont('bold', 8, classColor);
                doc.text(classification, layout.width - layout.margin - 45, boxStartY + 9.5, {align: 'right'});

                contentY += 5;
                
                // Stats below heading
                setFont('normal', 7.5, colors.slate600);
                const rawText = (typeof s.rawObserved !== 'undefined' && s.rawObserved !== null) ? (s.rawObserved + '%') : 'N/A';
                const adjText = (typeof s.adjusted !== 'undefined' && s.adjusted !== null) ? (s.adjusted + '%') : 'N/A';
                const nText = (typeof s.nAnswered !== 'undefined') ? s.nAnswered : '—';
                doc.text(`Raw: ${rawText}  |  Adj: ${adjText}  |  n=${nText}`, layout.margin + 4, contentY);
                
                contentY += 8;

                // Two-column content section
                const leftX = layout.margin + 4;
                const rightX = layout.width / 2 + 4;
                const colW = (layout.contentW / 2) - 10;

                setFont('bold', 8.5, colors.slate900);
                doc.text('SCIENTIFIC CONTEXT', leftX, contentY);
                const sciHeight = writeWrapped(s.scientific || '', leftX, contentY + 5, colW, 8, colors.slate500, 7.5);

                setFont('bold', 8.5, colors.slate900);
                doc.text('TRANSFORMATION GUIDANCE', rightX, contentY);
                const devHeight = writeWrapped(s.dev || '', rightX, contentY + 5, colW, 8, colors.slate500, 7.5);

                contentY += Math.max(sciHeight, devHeight) + 10;

                // Separator line
                doc.setDrawColor(...colors.slate100);
                doc.line(leftX, contentY, layout.width - layout.margin - 4, contentY);
                contentY += 6;

                // Development suggestions section
                setFont('bold', 8.5, colors.slate900);
                doc.text("PERSONAL DEVELOPMENT SUGGESTIONS", leftX, contentY);
                contentY += 6;

                checklistItems.forEach((c) => {
                   doc.setFillColor(...colors.cyan500);
                   doc.circle(leftX + 2, contentY - 1, 1.5, 'F');
                   setFont('normal', 7.5, colors.slate700);
                   const checkLines = doc.splitTextToSize(c, layout.contentW - 12);
                   doc.text(checkLines, leftX + 6, contentY);
                   contentY += (checkLines.length * 4) + 2; 
                });

                // Calculate total box height and draw box
                const totalBoxH = (contentY - boxStartY) + 6;
                doc.setDrawColor(...colors.slate100);
                doc.roundedRect(layout.margin, boxStartY, layout.contentW, totalBoxH, 3, 3, 'S');
                doc.setFillColor(...scoreCol);
                doc.roundedRect(layout.margin, boxStartY, 2, totalBoxH, 0, 0, 'F');
                
                // Move y to next position
                y = boxStartY + totalBoxH + 12;
            });

            // --- PAGE BEFORE METHODOLOGY: TREND GRAPH ---
            doc.addPage();
            addHeader();
            y = 35;
            setFont('bold', 16, colors.slate900);
            doc.text('AI INSTINCT INDEX - TREND', layout.margin, y);
            const thW = doc.getTextWidth('AI INSTINCT INDEX - TREND');
            doc.setFontSize(9); doc.setTextColor(6, 182, 212);
            doc.text('®', layout.margin + thW + 0.5, y - 4);
            y += 10;
            
            try {
                const history = this.getTrendData(record.user.email);
                this.drawTrend('trend-canvas-pdf', history, true); 
                await new Promise(r => setTimeout(r, 600)); 
                const tCanvas = document.getElementById('trend-canvas-pdf');
                if(tCanvas) {
                    const img = tCanvas.toDataURL('image/png');
                    const imgW = layout.contentW;
                    const imgH = imgW / 2;
                    doc.addImage(img, 'PNG', layout.margin, y, imgW, imgH);
                    
                    y += imgH + 10;
                    setFont('normal', 10, colors.slate700);
                    doc.text(`This graph visualizes the longitudinal progression of the Overall Readiness score across ${history.length} assessments.`, layout.margin, y);
                }
            } catch(e) { console.error('Trend graph pdf error', e); }

            // --- PAGE: SCORING NOTE (NEW - METHODOLOGY & SCORING NOTES) ---
            doc.addPage();
            addHeader();
            y = 35;
            
            setFont('bold', 20, colors.slate900);
            doc.text('SCORING NOTE', layout.margin, y);
            y += 15;

            // Instrument Details
            setFont('bold', 11, colors.teal500);
            doc.text('METHODOLOGY & SCORING NOTES', layout.margin, y);
            y += 10;

            // Instrument specification
            setFont('bold', 9, colors.slate900);
            doc.text('Instrument:', layout.margin, y);
            setFont('normal', 9, colors.slate700);
            doc.text('AI Instinct Index® v2.0.0 (2025-06)', layout.margin + 30, y);
            y += 7;

            setFont('bold', 9, colors.slate900);
            doc.text('Items:', layout.margin, y);
            setFont('normal', 9, colors.slate700);
            doc.text('46 statements across 11 behavioral dimensions (includes 2 reverse-coded attention checks)', layout.margin + 30, y);
            y += 7;

            setFont('bold', 9, colors.slate900);
            doc.text('Response Scale:', layout.margin, y);
            setFont('normal', 9, colors.slate700);
            const scaleText = '1 = Strongly Disagree · 2 = Disagree · 3 = Neutral · 4 = Agree · 5 = Strongly Agree';
            doc.text(scaleText, layout.margin + 30, y);
            y += 7;

            setFont('bold', 9, colors.slate900);
            doc.text('Sentinel Values:', layout.margin, y);
            setFont('normal', 9, colors.slate700);
            const sentinelText = 'null = item not answered (excluded from score); -1 = declined to answer';
            doc.text(sentinelText, layout.margin + 30, y);
            y += 10;

            // Scoring Algorithm Box
            doc.setFillColor(241, 245, 249);
            doc.roundedRect(layout.margin, y, layout.contentW, 28, 3, 3, 'F');
            
            setFont('bold', 10, colors.slate900);
            doc.text('Scoring Algorithm:', layout.margin + 5, y + 8);
            y += 14;
            setFont('normal', 9, colors.slate700);
            doc.text('Bayesian shrinkage: score = (n × raw% + K × prior) / (n + K), where K=3, prior=60%', layout.margin + 5, y);
            y += 6;
            setFont('italic', 8.5, colors.slate600);
            doc.text('Purpose: Prevents extreme scores from sparse responses; stabilizes estimates when few items are answered', layout.margin + 5, y);
            y += 15;

            // Overall Score
            setFont('bold', 9, colors.slate900);
            doc.text('Overall Score:', layout.margin, y);
            setFont('normal', 9, colors.slate700);
            const overallText = 'Unweighted mean of non-null dimension scores (all-skipped/declined dimensions excluded)';
            doc.text(doc.splitTextToSize(overallText, layout.contentW - 35), layout.margin + 30, y);
            y += 10;

            // Classification Box
            doc.setFillColor(20, 184, 166);
            doc.roundedRect(layout.margin, y, layout.contentW, 18, 3, 3, 'F');
            setFont('bold', 11, colors.white);
            doc.text('Classification:', layout.margin + 5, y + 7);
            setFont('bold', 10, colors.white);
            doc.text('Strong: 75–100%  ·  Moderate: 50–74%  ·  Emerging: 0–49%', layout.margin + 5, y + 13.5);
            y += 25;

            // Quality Flags
            setFont('bold', 9, colors.slate900);
            doc.text('Quality Flags:', layout.margin, y);
            y += 6;
            setFont('normal', 8.5, colors.slate700);
            const flagText = 'Records flagged if: completion < 120s, straightlining ≥ 10 consecutive same answered';
            doc.text(doc.splitTextToSize(flagText, layout.contentW - 10), layout.margin + 5, y);
            y += 10;

            // Reliability
            setFont('bold', 9, colors.slate900);
            doc.text('Reliability:', layout.margin, y);
            setFont('normal', 8.5, colors.slate700);
            const reliabilityText = "Cronbach's α computed per dimension from stored answer vectors (requires ≥2 responses)";
            doc.text(doc.splitTextToSize(reliabilityText, layout.contentW - 25), layout.margin + 25, y);
            y += 12;

            // Disclaimer Box
            doc.setFillColor(255, 251, 235);
            doc.setDrawColor(251, 191, 36);
            doc.setLineWidth(0.5);
            doc.roundedRect(layout.margin, y, layout.contentW, 22, 3, 3, 'FD');
            setFont('bold', 9, colors.slate900);
            doc.text('Disclaimer:', layout.margin + 5, y + 8);
            setFont('normal', 8.5, colors.slate700);
            const disclaimerText = 'This is an organizational/individual diagnostic tool, not a validated clinical or academic instrument.';
            doc.text(doc.splitTextToSize(disclaimerText, layout.contentW - 15), layout.margin + 5, y + 14);
            y += 30;

            // Contact Information
            setFont('bold', 10, colors.teal500);
            doc.text('For methodology enquiries or workshop facilitation:', layout.margin, y);
            y += 6;
            setFont('normal', 10, colors.cyan500);
            doc.text('Contact sreejith@futureowork.com', layout.margin, y);
            y += 10;

            // Branding
            setFont('bold', 14, colors.slate900);
            doc.text('AI Instinct Index', layout.margin, y);
            const brandW = doc.getTextWidth('AI Instinct Index');
            doc.setFontSize(9);
            doc.setTextColor(6, 182, 212);
            doc.text('®', layout.margin + brandW + 0.5, y - 3);


            // --- PAGE: METHODOLOGY NOTE ---
            doc.addPage();
            addHeader(); // Will include branding
            
            y = 35;
            setFont('bold', 20, colors.slate900);
            doc.text('METHODOLOGY NOTE', layout.margin, y);
            y += 15;

            const methodIntro = "This short note is written to be concise and transparent so respondents understand how scores are derived and why adjustments increase reliability.";
            y += writeWrapped(methodIntro, layout.margin, y, layout.contentW, 7, colors.slate500, 11);
            y += 12;

            // --- Display Raw Score & Adjusted Score prominently ---
            try {
                // Compute weighted raw overall and weighted adjusted overall using per-dimension weights
                let rawNumerator = 0, adjNumerator = 0, weightDenom = 0;
                (record.scores || []).forEach(s => {
                    const w = (s.expectedCount && s.nAnswered) ? (s.nAnswered / s.expectedCount) : 0;
                    if (w > 0) {
                        if (typeof s.rawObserved !== 'undefined' && s.rawObserved !== null) rawNumerator += (s.rawObserved * w);
                        if (typeof s.adjusted !== 'undefined' && s.adjusted !== null) adjNumerator += (s.adjusted * w);
                        weightDenom += w;
                    }
                });
                const rawOverall = weightDenom > 0 ? Math.round(rawNumerator / weightDenom) : null;
                const adjustedOverall = weightDenom > 0 ? Math.round(adjNumerator / weightDenom) : null;

                // Persist Raw and Adjusted overall scores for reporting
                record.rawOverall = rawOverall;
                record.adjustedOverall = adjustedOverall;

                // Display them prominently with proper spacing
                setFont('bold', 12, colors.slate900);
                const leftLabelX = layout.margin + 8;
                doc.text(`Raw Score: ${rawOverall === null ? 'N/A' : rawOverall + '%'}`, leftLabelX, y);
                doc.text(`Adjusted Score: ${adjustedOverall === null ? 'N/A' : adjustedOverall + '%'}`, leftLabelX + 75, y);
                y += 14;
            } catch(e) {
                console.error('Raw/Adjusted overall render error', e);
            }
            
            // Shrinkage box with proper spacing
            doc.setFillColor(30, 41, 59); 
            doc.setDrawColor(255, 255, 255); 
            doc.setLineWidth(0.1);
            doc.roundedRect(layout.margin, y, layout.contentW, 58, 3, 3, 'FD'); 

            setFont('bold', 12, colors.cyan500);
            doc.text("Shrinkage (conservative adjustment):", layout.margin + 8, y + 10);
            
            const shrinkText = "Shrinkage is applied only for dimensions with small answered counts (n < 4). This preserves raw scores when sufficient data exist. The shrinkage weight K is adaptive: it is reduced when per-dimension Cronbach's alpha is high. In practice, highly reliable dimensions are shrunk less. Reports show both raw observed percentage and adjusted (shrinkage) percentage for every dimension, along with nAnswered and Cronbach's alpha where available. Instrument completeness (proportion of answered items) is calculated; if <50% of items are answered the overall score is flagged as 'insufficient' and visibly penalized for completeness.";
            
            writeWrapped(shrinkText, layout.margin + 8, y + 18, layout.contentW - 16, 5.5, colors.slate100, 9);
            y += 68;

            setFont('bold', 12, colors.slate900);
            doc.text("Validity checks:", layout.margin, y);
            y += 12;

            const bullets = [
                "Reverse-coded items are included so agreement cannot be given automatically; items are scored directionally before aggregation.",
                "A 'Not sure / Prefer not to answer' option reduces forced, potentially inflated responses.",
                "Per-item timestamps are recorded and simple heuristics (e.g., unusually fast completion, repeated identical responses) are used to flag inattentive or satisficing response patterns.",
                "Social-desirability items may be optionally included; when present they are used to flag profiles with high impression-management tendencies."
            ];

            bullets.forEach(b => {
                doc.setFillColor(...colors.teal500);
                doc.circle(layout.margin + 3, y - 1.5, 1.5, 'F');
                const h = writeWrapped(b, layout.margin + 10, y, layout.contentW - 15, 6.5, colors.slate500, 10);
                y += h + 5;
            });

            // --- FINAL PAGE: APPENDIX (Word Doc Content) ---
            doc.addPage();
            addHeader();
            y = 35;
            setFont('bold', 16, colors.slate900);
            doc.text('APPENDIX: DIMENSION DEFINITIONS', layout.margin, y);
            y += 18;

            GLOSSARY_CONTENT.forEach(item => {
                // Check page overflow with more conservative margin
                if (y + 30 > layout.height - 20) {
                    doc.addPage();
                    addHeader();
                    y = 35;
                    setFont('bold', 16, colors.slate900);
                    doc.text('APPENDIX: DIMENSION DEFINITIONS (CONT.)', layout.margin, y);
                    y += 18;
                }

                setFont('bold', 11, colors.teal500);
                doc.text(item.title, layout.margin, y);
                y += 7;
                
                const descHeight = writeWrapped(item.desc, layout.margin, y, layout.contentW, 6, colors.slate700, 9);
                y += descHeight + 10; // Increased spacing between items
            });

            addFooter();

            const filename = `AI_Instinct_Report_${record.user.name.replace(/\s+/g,'_')}.pdf`;
            doc.save(filename);
        },

        adminIndivDownload(idx) { this.generatePDF(this.state.responses[idx]); },

        downloadPDF() {
            const current = this.state.responses.find(r => r.id === this.state.surveyId);
            if (current) this.generatePDF(current); else alert('No current report found. Complete the survey first.');
        },

        async adminTeamDownload() {
            try {
                if (!this.state || !this.state.responses || this.state.responses.length === 0) { alert('No responses.'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait', compress: true });

                const responses = this.state.responses;
                
                // --- CALCULATE TEAM METRICS ---
                const teamCount = responses.length;
                let totalOverall = 0;
                responses.forEach(r => totalOverall += r.overall);
                const avgOverall = Math.round(totalOverall / teamCount);

                const teamScores = dimensionsData.map(dim => {
                    let sum = 0;
                    responses.forEach(r => {
                        const dimScore = r.scores.find(s => s.name === dim.name)?.score || 0;
                        sum += dimScore;
                    });
                    return { name: dim.name, score: Math.round(sum / teamCount) };
                });

                // Style Definitions
                const colors = {
                    slate900: [15, 23, 42],
                    slate800: [30, 41, 59],
                    slate700: [51, 65, 85],
                    slate500: [100, 116, 139],
                    slate400: [148, 163, 184],
                    slate100: [241, 245, 249],
                    cyan500: [6, 182, 212],
                    teal500: [20, 184, 166],
                    rose500: [244, 63, 94],
                    white: [255, 255, 255],
                    cardBg: [250, 250, 250]
                };
                const layout = { margin: 15, width: 210, height: 297, contentW: 180 };

                // Elegant date formatter for Indian format (DD/MM/YYYY)
                const formatDate = (date) => {
                    const d = new Date(date);
                    const day = String(d.getDate()).padStart(2, '0');
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const year = d.getFullYear();
                    return `${day}/${month}/${year}`;
                };

                // Reuse Header/Footer logic
                const setFont = (type = 'normal', size = 10, color = colors.slate700) => {
                    doc.setFont('helvetica', type);
                    doc.setFontSize(size);
                    doc.setTextColor(...color);
                };

                const addHeader = () => {
                    doc.setFillColor(...colors.slate900);
                    doc.rect(0, 0, layout.width, 20, 'F');
                    setFont('bold', 12, colors.white);
                    doc.text('AI INSTINCT INDEX', layout.margin, 14);
                    // Header Branding with raised R on X
                    const w = doc.getTextWidth('AI INSTINCT INDEX');
                    doc.setFontSize(7); doc.text('®', layout.margin + w + 0.5, 11);
                    setFont('normal', 10, colors.cyan500);
                    doc.text(`Page ${doc.internal.getNumberOfPages()}`, layout.width - layout.margin, 14, { align: 'right' });
                };

                const addFooter = () => {
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        if (i === 1) continue;
                        setFont('normal', 8, colors.slate500);
                        doc.text('AI INSTINCT INDEX® - 11 Dimensions Behavioural Readiness Assessment I sreejith@futureowork.com', layout.margin, layout.height - 10);
                        doc.text(`Page ${i}`, layout.width - layout.margin, layout.height - 10, { align: 'right' });
                    }
                };

                // --- PAGE 1: TEAM COVER ---
                doc.setFillColor(...colors.slate900);
                doc.rect(0, 0, layout.width, layout.height, 'F');
                doc.setDrawColor(...colors.cyan500);
                doc.setLineWidth(0.5);
                doc.circle(layout.width + 20, 50, 80, 'S');
                doc.circle(layout.width + 20, 50, 70, 'S');
                
                let y = 80;
                setFont('bold', 12, colors.cyan500);
                doc.text('TEAM AGGREGATE REPORT', layout.margin, y);
                y += 15;
                setFont('bold', 42, colors.white);
                doc.text('AI INSTINCT', layout.margin, y);
                y += 15;
                doc.text('INDEX', layout.margin, y);
                doc.setFontSize(24); 
                // Position ® tightly after INDEX, raised near the top of X
                const idxW = doc.getTextWidth('INDEX');
                doc.text('®', layout.margin + idxW + 0.5, y - 5);
                
                y += 25;
                setFont('normal', 14, colors.slate500);
                doc.text('Prepared for:', layout.margin, y);
                y += 10;
                setFont('bold', 22, colors.white);
                doc.text("ORGANIZATION TEAM ANALYSIS", layout.margin, y);
                y += 8;
                setFont('normal', 11, colors.cyan500);
                doc.text(`${teamCount} Participants Included`, layout.margin, y);

                y += 40;
                const scoreSize = 30;
                const scoreColor = avgOverall >= 75 ? colors.teal500 : (avgOverall >= 50 ? colors.cyan500 : colors.rose500);
                doc.setDrawColor(...scoreColor);
                doc.setLineWidth(2);
                doc.circle(layout.margin + scoreSize, y + scoreSize, scoreSize, 'S');
                setFont('bold', 28, scoreColor);
                doc.text(`${avgOverall}%`, layout.margin + scoreSize, y + scoreSize + 3, {align: 'center'});
                setFont('bold', 10, colors.slate500);
                doc.text('TEAM MEAN READINESS', layout.margin + scoreSize, y + (scoreSize*2) + 12, {align: 'center'});
                setFont('normal', 10, colors.slate400);
                doc.text(formatDate(new Date()), layout.width - layout.margin, layout.height - 15, { align: 'right' });

                // --- PAGE 2: TEAM ANALYSIS ---
                doc.addPage();
                addHeader();
                y = 35;
                setFont('bold', 16, colors.slate900);
                doc.text('TEAM PROFILE ANALYSIS', layout.margin, y);
                y += 10;
                setFont('bold', 11, colors.slate800);
                doc.text("Aggregated behavioral profile of the selected group.", layout.margin, y);
                y += 10;
                setFont('normal', 9, colors.slate700);
                doc.text("This view highlights the collective strengths and blind spots of the team. High variance in specific dimensions may indicate a need for alignment workshops.", layout.margin, y, { maxWidth: layout.contentW });
                
                // Draw Team Radar
                y += 10;
                try {
                    this.drawRadar && this.drawRadar('radar-canvas', teamScores, true);
                    await new Promise(r => setTimeout(r, 600));
                    const canvas = document.getElementById('radar-canvas');
                    if (canvas) {
                        const img = canvas.toDataURL('image/png');
                        const imgSize = 110;
                        const xPos = (layout.width - imgSize) / 2;
                        doc.addImage(img, 'PNG', xPos, y, imgSize, imgSize);
                        y += imgSize + 5;
                    }
                } catch(e) { console.error("Team Radar error", e); y += 10; }

                // Team Stats
                const sorted = [...teamScores].sort((a,b) => b.score - a.score);
                const top3 = sorted.slice(0, 3);
                const low3 = sorted.slice(-3).reverse();

                const drawBox = (title, items, x, color) => {
                     doc.setFillColor(...colors.cardBg);
                     doc.roundedRect(x, y, 85, 45, 3, 3, 'F');
                     doc.setDrawColor(...colors.slate100);
                     doc.rect(x, y, 85, 45, 'S');
                     doc.setFillColor(...color);
                     doc.rect(x, y, 85, 2, 'F');
                     setFont('bold', 10, colors.slate900);
                     doc.text(title, x + 5, y + 10);
                     let iy = y + 18;
                     items.forEach(item => {
                         setFont('bold', 9, color);
                         doc.text(`${item.score}%`, x + 5, iy);
                         setFont('normal', 9, colors.slate700);
                         doc.text(item.name, x + 16, iy);
                         iy += 8;
                     });
                };

                if (y + 45 < layout.height - 20) {
                    drawBox("TEAM STRENGTHS (AVG)", top3, layout.margin, colors.teal500);
                    drawBox("OPTIMIZATION AREAS (AVG)", low3, layout.width/2 + 5, colors.rose500);
                }

                // --- PAGE 3: DETAILED ROSTER ---
                doc.addPage();
                addHeader();
                y = 35;
                setFont('bold', 16, colors.slate900);
                doc.text('DETAILED ROSTER', layout.margin, y);
                y += 15;

                const tableData = responses.map(r => [
                    r.user.name,
                    r.user.email,
                    r.user.country || '-',
                    r.overall + '%'
                ]);

                doc.autoTable({
                    startY: y,
                    head: [['Name', 'Email', 'Country', 'Score']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [15, 23, 42], textColor: [255, 255, 255], fontStyle: 'bold' },
                    styles: { fontSize: 8, cellPadding: 3 },
                    columnStyles: {
                        0: { fontStyle: 'bold' },
                        3: { halign: 'center', fontStyle: 'bold' }
                    }
                });

                addFooter();
                doc.save(`AI_Team_Report_${new Date().toISOString().slice(0,10)}.pdf`);

            } catch (ex) {
                console.error('Team PDF error', ex);
                alert('Team PDF generation failed. Check console.');
            }
        },

        exportMasterCSV() {
            // Headers
            let headers = [
                "Participant Name", "Email", "Country", "Protocol ID", "Completion Timestamp"
            ];

            // Item Headers (1-68)
            for(let i=1; i<=68; i++) headers.push(`item_${i}`);

            // Time Headers (1-68)
            for(let i=1; i<=68; i++) headers.push(`time_${i}`);

            // Quality Headers
            headers.push("flag_tooFast", "flag_straightline", "flag_insufficientOverall");

            // Dimension Headers (1-11)
            dimensionsData.forEach((d, i) => {
                const p = `Dim${i+1}`;
                headers.push(`${p}_rawObserved`, `${p}_adjusted`, `${p}_nAnswered`);
            });

            // Reliability
            headers.push("Cronbach_Alpha");

            let csvContent = headers.join(",") + "\n";

            this.state.responses.forEach(r => {
                let row = [];

                // Metadata
                const escape = (txt) => `"${(txt || '').toString().replace(/"/g, '""')}"`;
                row.push(escape(r.user.name));
                row.push(escape(r.user.email));
                row.push(escape(r.user.country));
                row.push(escape(r.id));
                row.push(escape(r.timestamp));

                // Items (Raw)
                for(let i=0; i<68; i++) {
                    const ans = (r.answers && r.answers[i] !== undefined) ? r.answers[i] : "";
                    row.push(ans);
                }

                // Times (Deltas)
                const times = r.answerTimes || [];
                for(let i=0; i<68; i++) {
                    if (i === 0) {
                        row.push(""); 
                    } else {
                        const curr = times[i];
                        const prev = times[i-1];
                        if (curr && prev) row.push(curr - prev);
                        else row.push("");
                    }
                }

                // Quality Flags
                const q = r.quality || {};
                row.push(q.tooFast || false);
                row.push(q.straightline || false);
                row.push(q.insufficientOverall || false);

                // Dimensions
                if (r.scores) {
                    dimensionsData.forEach(d => {
                        const s = r.scores.find(sc => sc.name === d.name);
                        if (s) {
                            row.push(s.rawObserved !== undefined ? s.rawObserved : "");
                            row.push(s.adjusted !== undefined ? s.adjusted : "");
                            row.push(s.nAnswered !== undefined ? s.nAnswered : "");
                        } else {
                            row.push("","","");
                        }
                    });
                } else {
                     for(let k=0; k<33; k++) row.push("");
                }

                // Alpha
                row.push(r.alphas ? `"${r.alphas.join('|')}"` : "");

                csvContent += row.join(",") + "\n";
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "AI_Instinct_Master_Export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        },

        exportCSV() {
            let csv = "ID,Name,Email,Country,Device,Overall," + dimensionsData.map(d => d.name).join(",") + "\n";
            this.state.responses.forEach(r => csv += `${r.id},${r.user.name},${r.user.email},${(r.user.country||'')},${(r.device||'')},${r.overall}%,` + r.scores.map(s => s.score).join(",") + "\n");
            const b = new Blob([csv], { type: 'text/csv' }); const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = `AI_Master_Data.csv`; a.click();
        }
    };

    window.onload = () => app.init();
    
try {
(function(){
  function safeInject(){
    try{
      const rows=document.querySelectorAll('tbody tr');
      if(!rows.length) return;
      rows.forEach((tr,i)=>{
        if(tr.querySelector('.miniTrend')) return;
        const td=tr.querySelector('td');
        if(!td) return;
        const c=document.createElement('canvas');
        c.width=140;c.height=40;
        c.className='miniTrend';
        c.style.display='block';
        c.style.marginTop='6px';
        td.appendChild(c);
        try{
          if(window.app && app.getTrendData && app.drawTrend){
            const email=(tr.innerText.match(/\S+@\S+/)||[''])[0];
            const h=app.getTrendData(email||'');
            app.drawTrend(c.id= 'mt'+i,h,false);
          }
        }catch(e){}
      });
    }catch(e){}
  }
  new MutationObserver(()=>safeInject()).observe(document.body,{childList:true,subtree:true});
  window.addEventListener('load',()=>setTimeout(safeInject,300));
})();
}catch(e){}

try{
const _origGeneratePDF = generatePDF;
generatePDF = async function(record){
  try{
    const pdf = await _origGeneratePDF.apply(this, arguments);
  }catch(e){}
}
}catch(e){}


        // --- NSNA helper: visually mark 'Not sure/Prefer not to answer' selections ---
        function _markNsnaForIndex(idx) {
            try {
                // 1) mark the question area
                const surveyInner = document.getElementById('survey-inner');
                if (surveyInner) {
                    // find current question card inside survey-inner (heuristic)
                    const qcard = surveyInner.querySelector('.bg-slate-800, .bg-white, .rounded-xl, .question-card') || surveyInner.querySelector('div');
                    if (qcard) qcard.classList.add('nsna-selected');
                }
                // 2) attempt to find a status/progress dot corresponding to this question and mark it red
                // Common patterns:
                let dot = document.querySelector(`[data-qidx="${idx}"] .status-dot`) || document.querySelector(`.q-nav [data-qidx="${idx}"] .dot`) || document.querySelector(`.progress-indicator .item[data-idx="${idx}"] .dot`);
                if (!dot) {
                    // try numeric id forms
                    dot = document.getElementById('dot-' + idx) || document.getElementById('qdot-' + idx) || document.querySelector(`.dot[data-idx='${idx}']`);
                }
                if (dot) {
                    dot.classList.add('nsna');
                    dot.style.background = '#ef4444';
                    dot.style.borderColor = '#ef4444';
                } else {
                    // As a fallback, try to color any small circular element at position idx in a list
                    const dots = document.querySelectorAll('.dot, .circle, .status, .indicator');
                    if (dots && dots.length > idx) {
                        const d = dots[idx];
                        d.classList.add('nsna');
                        d.style.background = '#ef4444';
                        d.style.borderColor = '#ef4444';
                    }
                }
            } catch (e) {
                console.warn('_markNsnaForIndex failed', e);
            }
        }


        // Add CSS for visual clue and nsna selected styling
        (function(){
            const css = `
            .nsna-selected { position: relative; }
            .nsna-selected::after { content: 'Prefer not to answer'; position: absolute; right: 12px; top: 6px; background: rgba(239,68,68,0.12); color: #ef4444; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; }
            .status-dot.nsna, .dot.nsna { background: #ef4444 !important; border-color: #ef4444 !important; }
            `;
            const s = document.createElement('style'); s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
        })();
</script>

        
        
    <div class="methodology-callouts" style="margin-top:12px;padding:12px;border-left:4px solid #0ea5a4;background:#f8fafb;">
      <h4 style="margin:0 0 6px 0;font-weight:700;">Key reporting conventions</h4>
      <p style="margin:0 0 8px 0;">To ensure clarity and scientific rigour, the report presents both the observed measure and the statistically adjusted score. The following are presented for each dimension:</p>
      <ul style="margin:6px 0 8px 18px;">
        <li><strong>rawObserved</strong> — the direct percentage computed from answered items (transparent, intuitive).</li>
        <li><strong>adjusted</strong> — the conservative shrinkage-adjusted percentage (used to stabilise estimates when data are sparse).</li>
        <li><strong>nAnswered</strong> and <strong>expectedCount</strong> — the count of items answered in the dimension.</li>
        <li><strong>Cronbach's alpha</strong> — when available, showing internal reliability (null if not computable).</li>
      </ul>
      <p style="margin:0 0 8px 0;">Completeness and flags:</p>
      <ul style="margin:6px 0 0 18px;">
        <li><strong>Instrument completeness</strong> — proportion of all items answered; if &lt;50% the overall score is flagged as <em>insufficient</em> and visibly penalised.</li>
        <li><strong>Insufficient dimensions</strong> — dimensions with too few answered items are marked and their scores may be omitted from the overall aggregation.</li>
        <li><strong>Quality flags</strong> — automatic indicators (tooFast, straightline) appear prominently; flagged responses are recommended for review or exclusion from norms.</li>
      </ul>
      <p style="margin:10px 0 0 0;font-size:0.92em;color:#334155;">These conventions are applied to increase interpretability for participants and confidence for corporate stakeholders while preserving statistical conservatism where data are sparse.</p>
    </div>
    </body>
</html>